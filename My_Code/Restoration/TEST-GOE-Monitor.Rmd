---
title: "TEST Shiny GOE Monitor DataViz"
author: "Wendy Anthony"
date: "2025/08/20"
output:
  html_document:
    toc: yes 
    toc_depth: 3
    toc_float: yes
    number_sections: yes
---
Creation date: 2025/08/04
Modified Date & Time: 2025/08/27 @ 08:29

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries
```{r load_libraries}
library(shiny)
library(tidyverse)
library(plotly)
library(DiagrammeR)
```


# Data
- Note Data is in `TEST-GOE-Monitor.xlsx` file, with one worksheet for Data, and one worksheet for Site info
- Save each worksheet to 2 separate csv files `Site-Data-TEST-GOE-Monitor.csv` & `SiteData-TEST-GOE-Monitor.csv`

## Load Data
- Data Cleaning to ensure no space at beginning of any text values and column headings
Note: SiteDetails-TEST-GOE-Monitor.csv has space in front of values 
 NEED TO change `TEST-GOE-Monitor.xlsx` excel file first, then resave as csv
```{r load-data}
# Site Data
geo_eccc <- read.csv("SiteData-TEST-GOE-Monitor.csv", header = TRUE, sep = ",")
# Site Details
Sites_eccc <- read.csv("SiteDetails-TEST-GOE-Monitor.csv", header = TRUE, sep = ",")
```

## Data Discovery

## Column Names Data
```{r data-1}
colnames(geo_eccc)
```

## Column Names Sites
```{r data-2}
colnames(Sites_eccc)
```

# Data Manipulation

## proportion to Percentage_of_native_species
```{r create-percentage-number}
# using scales creates % character instead of number
# Percentage_of_native_species <- scales::percent(geo_eccc$Proportion_of_native_species)
# Percentage_of_native_species 

Percentage_ns <- geo_eccc$Proportion_of_native_species * 100
Percentage_ns
```


## add `Percentage_ns` data to column
<details><summary><b><i>Click to see results of `data`</i></b></summary><p>
```{r add-column}
# https://sparkbyexamples.com/r-programming/add-column-to-dataframe-in-r/
# geo_eccc_1 <- cbind(geo_eccc, Percentage_of_native_species)
# geo_eccc_1

geo_eccc <- cbind(geo_eccc, Percentage_ns)
geo_eccc
```

## Check data structure of new column
```{r data-structure-new-column}
str(geo_eccc)
```

</p></details>

## Data Structure Data
- make sure each column is same data type in both data files
```{r data-structure-1}
str(geo_eccc)
```

## Data Structure Sites
- make sure each column is same data type
```{r data-structure-2}
str(Sites_eccc)
```

## Combine Dataframes 
- first make sure they have the same number of rows 
```{r cbind}
length(unique(geo_eccc$Site))
length(unique(Sites_eccc$Site))
```

### Arrange Order
- Site details Site names are in different order than Site Data, so put each site in alphabetical order first
```{r arange-order-df}
# tidyverse
# https://stackoverflow.com/questions/68989228/sort-dataframe-by-column-value-r
Sites_eccc_1 <- Sites_eccc %>% arrange(Sites_eccc$Site)
geo_eccc_1 <- geo_eccc %>% arrange(geo_eccc$Site)
```

### cbind arranged df works
- (`merge` doesn't work, leaves columns empty)

```{r cbind-arranged-df}
geo_eccc_sites <- cbind(Sites_eccc_1, geo_eccc_1)
names(geo_eccc_sites)
```

### remove duplicate columns
- now there are 2 columns with same name for, Subregion, Site

```{r remove-duplicate-columns}
# https://stackoverflow.com/questions/7072159/how-do-you-remove-columns-from-a-data-frame
geo_eccc_sites_1 <- geo_eccc_sites[c(-9,-10)]
names(geo_eccc_sites_1)
```

### Rename columns with . using base R
```{r rename-columns-baseR}

names(geo_eccc_sites_1)[names(geo_eccc_sites_1) == "Land.Manager"] <- "Land_Manager"
names(geo_eccc_sites_1)[names(geo_eccc_sites_1) == "Main.Restoration.Type"] <- "Main_Restoration_Type"
names(geo_eccc_sites_1)[names(geo_eccc_sites_1) == "Restoration.Intensity"] <- "Restoration_Intensity"
names(geo_eccc_sites_1)[names(geo_eccc_sites_1) == "Area.ha"] <- "Area_ha"

names(geo_eccc_sites_1)
```



### Create and save new csv file with both datasets 
```{r create-csv-combined-datasets}
write.csv(geo_eccc_sites_1, "geo_eccc_all_site_data.csv", row.names = FALSE)
```


---

# Plots
## Site by Percentage Native Species
```{r plots-site-native-species}
site_natsp <- ggplot(geo_eccc, 
                    aes(x = Site, y = Percentage_ns)) +
                    geom_point(shape = 18, size = 2) +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Site by Percentage Native Species',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-04")
site_natsp

```

## Site by Composite_Index
```{r plots-Composite-Index}
site_natsp <- ggplot(geo_eccc, 
                    aes(x = Site, y = Composite_Index)) +
                    geom_point(shape = 18, size = 2) +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Site by Composite Index',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-04")
site_natsp
```

## TEST DOESn't Reorder Site by Restoration_Intensity
- note Reay Islet was showing a separate High, so in original csv I copied High value from another site,
aslo Scafe Hill had a different low value ...
- also all high values have a space in front ... change all ... 
- Having trouble ordering Restoration_Intensity values ... see next example

<details><summary><b><i>Click to see results of `TEST`</i></b></summary><p>
```{r plots-site-Restoration-Intensity}
# names(geo_eccc_sites_1)
# str(geo_eccc_sites_1)
# unique(geo_eccc_sites_1$Restoration_Intensity)
# 
# # change character to factor
# geo_eccc_sites_1$Restoration_Intensity <- as.factor(geo_eccc_sites_1$Restoration_Intensity)
# # change factor to character
# geo_eccc_sites_1 <- data.frame(lapply(geo_eccc_sites_1, as.character), stringsAsFactors=FALSE)
# 
# # WORKS !!!
# Restoration_Intensity_order <- c("high", "moderate", "low", "minimal")
# arranged_geo_eccc_sites_1 <- geo_eccc_sites_1 %>% 
#   arrange(factor(Restoration_Intensity, levels = Restoration_Intensity_order))
# arranged_geo_eccc_sites_1
# str(arranged_geo_eccc_sites_1)
# 
# # still not showing the order
# site_restInt <- ggplot(arranged_geo_eccc_sites_1,
#        aes(x = Site, y = Restoration_Intensity, color = Subregion)) +
#                     geom_point(shape = 18, size = 2) +
#   #geom_bar(stat="identity") +
#                     theme_minimal() + #get rid of grey background and tick marks 
#                     theme(legend.position="bottom") + #remove legend 
#                     theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
#                     labs(title='Plotting Site by Restoration_Intensity',
#                       subtitle='ECCC',
#                       caption = "Chart by Wendy Anthony \n 2025-08-20")
# site_restInt

# ggplotly(site_restInt)
```

</p></details>



## ORDER NOT WORKING TEST Site by Restoration_Intensity and Exotic_species

```{r plots-site-Restoration-Intensity-Exotic}
names(geo_eccc_sites_1)
str(geo_eccc_sites_1)

# Step 1
desired_levels <- c("high", "moderate", "low", "minimal")
# create new df to create desired levels
geo_eccc_sites_2 <- geo_eccc_sites_1
# this changes data type from character to factor
geo_eccc_sites_2$Restoration_Intensity <- factor(geo_eccc_sites_1$Restoration_Intensity, levels = desired_levels)
print(levels(geo_eccc_sites_2$Restoration_Intensity)) # New order of levels
str(geo_eccc_sites_2)
# step 2
geo_eccc_sites_2 <- geo_eccc_sites_2[order(geo_eccc_sites_2$Restoration_Intensity),]

site_restInt_exotic <- ggplot(geo_eccc_sites_2,
       aes(x = Exotic_species, y = Restoration_Intensity, color = Site)) +
                    geom_point(shape = 18, size = 2) +
  #geom_bar(stat="identity") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend legen won't stick to bottom with ggplotly
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Site by Restoration_Intensity & Exotic Species',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-20")
site_restInt_exotic

# ggplotly(site_restInt_exotic)
# change ggplotly legend to bottom
  # %>% 
 #      plotly::layout(legend=list(x=0, 
 #                                 xanchor='left',
 #                                 yanchor='bottom',
 #                                 orientation='h'))    
```


## ORDER WORKs Point Plot Site by Restoration_Intensity

```{r plots-site-Restoration-Intensity-order-point}
names(geo_eccc_sites_1)
# Reorder following a precise order
# https://r-graph-gallery.com/267-reorder-a-variable-in-ggplot2.html
# https://stackoverflow.com/questions/18413756/re-ordering-factor-levels-in-data-frame
# mydf$task <- factor(mydf$task, levels = c("up", "down", "left", "right", "front", "back"))
#geo_eccc_sites_1$Restoration_Intensity <- factor(geo_eccc_sites_1$Restoration_Intensity, levels = #c("high", "moderate", "low", "minimal"))
str(geo_eccc_sites_1)

# change character to factor
# str(geo_eccc_sites_1)
# geo_eccc_sites_1$Restoration_Intensity <- as.factor(geo_eccc_sites_1$Restoration_Intensity)
# str(geo_eccc_sites_1)
# # change factor to character
# geo_eccc_sites_1 <- data.frame(lapply(geo_eccc_sites_1, as.character), stringsAsFactors=FALSE)
# str(geo_eccc_sites_1)

# Step 1
desired_levels <- c("high", "moderate", "low", "minimal")
# create new df to create desired levels
geo_eccc_sites_2 <- geo_eccc_sites_1
# this changes data type from character to factor
geo_eccc_sites_2$Restoration_Intensity <- factor(geo_eccc_sites_1$Restoration_Intensity, levels = desired_levels)
print(levels(geo_eccc_sites_2$Restoration_Intensity)) # New order of levels
str(geo_eccc_sites_2)
# step 2
geo_eccc_sites_2 <- geo_eccc_sites_2[order(geo_eccc_sites_2$Restoration_Intensity),]

# values in order now -- ?? how to change to reverse order 
site_restInt <- ggplot(geo_eccc_sites_2,
       aes(x = Site, y = reorder(Restoration_Intensity, desc(Restoration_Intensity)), color = Subregion)) +
  # reorder y variable axis
  # https://stackoverflow.com/questions/28391850/reverse-order-of-discrete-y-axis-in-ggplot2s
# y = Restoration_Intensity
                    geom_point(shape = 18, size = 2) +
  #geom_bar(stat="identity") +
  # Replace default palette of pink & blue
  scale_fill_brewer(palette = "Dark2") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="bottom") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Sites by Restoration Intensity',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-22", x = "Site", y = "Restoration Intensity")

site_restInt


ggplotly(site_restInt)
```

## Change x axis ORDER WORKs Point Plot Site by Restoration_Intensity

```{r plots-site-Restoration-Intensity-order-point-1}
names(geo_eccc_sites_1)
# Reorder following a precise order
# https://r-graph-gallery.com/267-reorder-a-variable-in-ggplot2.html
# https://stackoverflow.com/questions/18413756/re-ordering-factor-levels-in-data-frame
# mydf$task <- factor(mydf$task, levels = c("up", "down", "left", "right", "front", "back"))
#geo_eccc_sites_1$Restoration_Intensity <- factor(geo_eccc_sites_1$Restoration_Intensity, levels = #c("high", "moderate", "low", "minimal"))
str(geo_eccc_sites_1)

# change character to factor
# str(geo_eccc_sites_1)
# geo_eccc_sites_1$Restoration_Intensity <- as.factor(geo_eccc_sites_1$Restoration_Intensity)
# str(geo_eccc_sites_1)
# # change factor to character
# geo_eccc_sites_1 <- data.frame(lapply(geo_eccc_sites_1, as.character), stringsAsFactors=FALSE)
# str(geo_eccc_sites_1)

# Step 1
desired_levels <- c("high", "moderate", "low", "minimal")
# create new df to create desired levels
geo_eccc_sites_2 <- geo_eccc_sites_1
# this changes data type from character to factor
geo_eccc_sites_2$Restoration_Intensity <- factor(geo_eccc_sites_1$Restoration_Intensity, levels = desired_levels)
print(levels(geo_eccc_sites_2$Restoration_Intensity)) # New order of levels
str(geo_eccc_sites_2)
# step 2
geo_eccc_sites_2 <- geo_eccc_sites_2[order(geo_eccc_sites_2$Restoration_Intensity),]

# values in order now -- ?? how to change to reverse order 
site_restInt_x <- ggplot(geo_eccc_sites_2,
       aes(x = reorder(Site, 
                       # -desc reverses descending
                       -desc(Restoration_Intensity)), 
           y = reorder(Restoration_Intensity, desc(Restoration_Intensity)), color = Subregion)) +
  # reorder y variable axis
  # https://stackoverflow.com/questions/28391850/reverse-order-of-discrete-y-axis-in-ggplot2s
# y = Restoration_Intensity
                    geom_point(shape = 18, size = 2) +
  #geom_bar(stat="identity") +
  # Replace default palette of pink & blue
  # makes ggploty legend show (Saanich Peninsula,1)
#  scale_fill_brewer(palette = "Dark2") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="bottom") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Site by Restoration_Intensity',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-26",
                      x = "Site", y = "Restoration_Intensity")
site_restInt_x

ggplotly(site_restInt_x)
```

## BAR Plot WORKS Site by Restoration_Intensity

```{r plots-site-Restoration-Intensity-order-bar}
names(geo_eccc_sites_1)
# Reorder following a precise order
# https://r-graph-gallery.com/267-reorder-a-variable-in-ggplot2.html
# https://stackoverflow.com/questions/18413756/re-ordering-factor-levels-in-data-frame
# mydf$task <- factor(mydf$task, levels = c("up", "down", "left", "right", "front", "back"))
#geo_eccc_sites_1$Restoration_Intensity <- factor(geo_eccc_sites_1$Restoration_Intensity, levels = #c("high", "moderate", "low", "minimal"))
str(geo_eccc_sites_1)

# change character to factor
# str(geo_eccc_sites_1)
# geo_eccc_sites_1$Restoration_Intensity <- as.factor(geo_eccc_sites_1$Restoration_Intensity)
# str(geo_eccc_sites_1)
# # change factor to character
# geo_eccc_sites_1 <- data.frame(lapply(geo_eccc_sites_1, as.character), stringsAsFactors=FALSE)
# str(geo_eccc_sites_1)

# Step 1
desired_levels <- c("high", "moderate", "low", "minimal")
# this changes data type from character to factor
geo_eccc_sites_2$Restoration_Intensity <- factor(geo_eccc_sites_1$Restoration_Intensity, levels = desired_levels)
print(levels(geo_eccc_sites_2$Restoration_Intensity)) # New order of levels
str(geo_eccc_sites_2)
# step 2
geo_eccc_sites_2 <- geo_eccc_sites_2[order(geo_eccc_sites_2$Restoration_Intensity),]

# values in order now -- ?? how to change to reverse order 
site_restInt_bar <- ggplot(geo_eccc_sites_2,
       aes(y = reorder(Restoration_Intensity, desc(Restoration_Intensity)), color = Site, fill = Site)) +
  # reorder y variable axis
  # https://stackoverflow.com/questions/28391850/reverse-order-of-discrete-y-axis-in-ggplot2s
# y = Restoration_Intensity
                    geom_bar() +
  #geom_bar(stat="identity") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="bottom") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Site by Restoration_Intensity',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-26", y = "Restoration_Intensity")
site_restInt_bar


ggplotly(site_restInt_bar)
```

## Violin Subregion by Exotic_species
```{r plots-Exotic-species}
subregion_exsp <- ggplot(geo_eccc, 
                    aes(x = Subregion, y = Exotic_species)) +
                    geom_violin(fill = "seagreen2") +
                    geom_boxplot(width = 0.1, fill = "sandybrown") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(vjust = 1, size = 9)) +
                    labs(title='Plotting Subregion by Exotic_species',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-04")
subregion_exsp
# plotly won't work here
```

## Violin Subregion by Percentage_ns
```{r plots-Percentage-ns}
names(geo_eccc)
subregion_nsp <- ggplot(geo_eccc, 
                    aes(x = Subregion, y = Percentage_ns)) +
                    geom_violin(fill = "seagreen2") +
                    geom_boxplot(width = 0.1, fill = "sandybrown") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(vjust = 1, size = 9)) +
                    labs(title='Plotting Subregion by Percentage of Native Species',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-27")
subregion_nsp
# plotly won't work here
```

## Cowplot Violin Subregion plot_grid
```{r cowplot-violin-subr}
library(cowplot)

subregion_exsp_1 <- subregion_exsp + labs(title='Exotic Species',
                      subtitle='ECCC',
                      caption = "2025-08-27")

subregion_nsp_1 <- subregion_nsp + labs(title='Native Species',
                      subtitle='ECCC',
                      caption = "2025-08-27")

plot_grid(subregion_exsp_1, subregion_nsp_1, labels = "AUTO")

```


## TEST NOTWorking Bar Chart Subregion by Restoration_Intensity
```{r plots-Restoration-Intensity}
names(geo_eccc_sites_1)
str(geo_eccc_sites_1)

subregion_restInt <- ggplot(geo_eccc_sites_1, 
                    aes(y = Restoration_Intensity)) +
#                    geom_violin(fill = "seagreen2") +
                    geom_bar(width = 0.1, fill = "sandybrown") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Subregion by Restoration_Intensity',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-20")
subregion_restInt
ggplotly()
# plotly won't work here
```

## Subregion by Proportion_of_native_species
```{r plots-Subregion-Percentage-of-native-species}
subregion_natsp <- ggplot(geo_eccc_1, 
                    aes(x = Subregion, y = Percentage_ns)) +
                    geom_violin(fill = "seagreen2") +
                    geom_boxplot(width = 0.1, fill = "sandybrown") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Subregion by Proportion_of_native_species',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-04")
subregion_natsp
```



---
---


# Plots by Separate Sites
- use pivot_longer() for single row with multiple columns convert to long

## pivot longer one row to long df
```{r pivot-longer}
colnames(geo_eccc_1)
# choose index row from data sorted alphabetically
# delete first 2 columns as they can't be characters ? also Proportion to leave Percentage 
# delete year column

# Anniversary_Island
Anniversary_Island <- geo_eccc_1[1, ]
Anniversary_Island
Anniversary_Island <- Anniversary_Island[, -c(1,2,9)]
Anniversary_Island_long <- Anniversary_Island %>% pivot_longer(everything(), names_to = "variable", values_to = "value")
Anniversary_Island_long

# Gonzales
Gonzales <- geo_eccc_1[15, ]
Gonzales
Gonzales <- Gonzales[, -c(1,2,9)]
Gonzales
Gonzales_long <- Gonzales %>% pivot_longer(everything(), names_to = "variable", values_to = "value")
Gonzales_long

# Uplands
Uplands <- geo_eccc_1[24, ]
Uplands
Uplands <- Uplands[, -c(1,2,9)]
Uplands
Uplands_long <- Uplands %>% pivot_longer(everything(), names_to = "variable", values_to = "value")
Uplands_long
```

## Point Plot Long Uplands
```{r plots-Uplands}
Uplands_long_plot  <-  ggplot(Uplands_long, 
                    aes(x = variable, y = value)) +
  # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
                    ylim(0, 100) +
                    geom_point() +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Uplands Variables',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-04")
Uplands_long_plot
```

## Point Plot to Compare Gonzales Variables
```{r plots-Gonzales-compare-1}
Gonzales_long_plot  <-  ggplot(Gonzales_long, 
                    aes(x = variable, y = value)) +
  # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
                    ylim(0, 100) +
                    geom_point() +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Gonzales Variables',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-04")
Gonzales_long_plot
```

## Point Plot Long Anniversary_Island_long
```{r plots-Gonzales}
Anniversary_Island_long_plot  <-  ggplot(Anniversary_Island_long, 
                    aes(x = variable, y = value)) +
  # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
                    ylim(0, 100) +
                    geom_point() +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Plotting Anniversary Island Variables',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-04")
Anniversary_Island_long_plot
```


## Bar Variables Compare Uplands
```{r compare-bar-Variables-uplands}

compare_bar_uplands  <-  ggplot(Uplands_long, 
                    aes(x = variable, y = value)) +
  
# Exotic_species
  # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
                    ylim(0, 100) +
                    geom_bar(stat = "identity", fill = "seagreen") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Comparinging Uplands Variables',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-08")
compare_bar_uplands
```

## Compare Bar Variables multiple sites
```{r compare-bar-Variables-multiple-sites}

names(geo_eccc_1)
compare_bar_multiple_sites  <-  ggplot(geo_eccc_1,
                    aes(x = Site, y = Percentage_ns, fill = Subregion)) +
  
# Exotic_species
  # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
                    ylim(0, 100) +
                    geom_bar(stat = "identity") +
  # Replace default palette of pink & blue
  scale_fill_brewer(palette = "Dark2") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Comparinging Site Variables',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-08")
compare_bar_multiple_sites
```

## Arrange Compare Bar Variables multiple sites
```{r compare-bar-Variables-multiple-sites-order}
# https://r-graph-gallery.com/267-reorder-a-variable-in-ggplot2.html
names(geo_eccc_1)
# arrange values
#str(arr)
# geo_eccc_1 %>% arrange(Percentage_ns) -> arr
geo_eccc_1 %>% arrange(desc(Percentage_ns)) %>%
  # updates Site with new arrangement
   mutate(Site = factor(Site, levels = Site)) %>% 
    ggplot(
      aes(x = Site, y = Percentage_ns, fill = Subregion)) +
  # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
                    ylim(0, 100) +
                    geom_bar(stat = "identity") +
  # Replace default palette of pink & blue
  scale_fill_brewer(palette = "Dark2") +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="bottom") + 
                    theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Comparinging Sites',
                      subtitle='ECCC GOE Site Monitoring',
                      caption = "Chart by Wendy Anthony \n 2025-08-19")

```


## TEST Stacking Bar Variables multiple sites
```{r stacking-bar-Variables-multiple-sites}
# https://r-graph-gallery.com/267-reorder-a-variable-in-ggplot2.html
# View(mpg)
# g <- ggplot(geo_eccc_1, aes(Subregion))  
# p <-  g + geom_bar(aes(fill = Site))
# ggplotly(p)
# 
# #https://stackoverflow.com/questions/6693257/making-a-stacked-bar-plot-for-multiple-variables-ggplot2-in-r
# dfr <- data.frame(
#   V1 = c(0.1, 0.2, 0.3),
#   V2 = c(0.2, 0.3, 0.2),
#   V3 = c(0.3, 0.6, 0.5),
#   V4 = c(0.5, 0.1, 0.7),
#   row.names = LETTERS[1:3]
# )
# 
# geo_eccc_2 <- subset(geo_eccc_1, , -c(Subregion))
# 
# geo_eccc_2 %>% rownames_to_column("ID") %>% pivot_longer(!ID) %>%
#   ggplot() +
#   geom_col(aes(x = ID, y = value, fill = name), position = 'fill')
# # Error in `pivot_longer_spec()`:
# #! Can't combine `Site` <character> and `Proportion_of_native_species` <double>.
# 
# names(geo_eccc_1)
#     ggplot(geo_eccc_1,
#       aes(x = Site, y = Percentage_ns, fill = Subregion, color = Subregion)) +
#   # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
#                     ylim(0, 100) +
#                     geom_bar(stat = "identity") +
#                     theme_minimal() + #get rid of grey background and tick marks 
#                     theme(legend.position="bottom") + 
#                     theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust=1, size = 7)) +
#                     labs(title='Comparinging Sites',
#                       subtitle='ECCC GOE Site Monitoring',
#                       caption = "Chart by Wendy Anthony \n 2025-08-19")

```

## ??? NOTWORKING Compare Column Variables Uplands
```{r compare-col-Variables}
colnames(geo_eccc_1)

geo_eccc_1_filter <- filter(geo_eccc_1, geo_eccc_1$Site %in% c("Uplands Park", "Trial Island")) 


compare_col_uplands <- ggplot(geo_eccc_1_filter, 
  aes(Site, fill = Exotic_species)) + 
  geom_bar(position = "dodge", alpha = 0.5) +
                    theme_minimal() + #get rid of grey background and tick marks 
                    theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
                    labs(title='Comparinging Uplands Variables',
                      subtitle='ECCC',
                      caption = "Chart by Wendy Anthony \n 2025-08-08")
compare_col_uplands
```



---


# TEST NOT WORKING Facet wraps
## facet_wrap(~Subregion)
- need to filter Subregion for each ???
```{r facet-wraps}
names(geo_eccc_1)

ggplot(geo_eccc_1, 
       aes(x = Site, y = Exotic_species)) +
  geom_col() +
  facet_wrap(~Subregion) +
  theme(legend.position="none") + #remove legend 
   theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
   labs(title='Comparinging Uplands Variables',
      subtitle='ECCC',
      caption = "Chart by Wendy Anthony \n 2025-08-19")
```

## ??? TEST FILTER SAME AS PREVIOUS NOT WORKINGfacet_wrap
- need to filter Subregion for each ???
```{r facet-wraps-test}
names(geo_eccc_1)

ggplot(geo_eccc_1, 
       aes(x = Site, y = Exotic_species)) +
  geom_col() +
  facet_wrap(~Subregion) +
  theme(legend.position="none") + #remove legend 
   theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
   labs(title='Comparinging Uplands Variables',
      subtitle='ECCC',
      caption = "Chart by Wendy Anthony \n 2025-08-19")
```


---

# Test GGplot Function
## Violin Chart Function
```{r Test-GGplot-Function-violin}
geo_eccc <- read.csv("SiteData-TEST-GOE-Monitor.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
str(geo_eccc)
names(geo_eccc)

subregion_var_violin <- function(file, title, subtitle, colx, coly, xlab, ylab, caption){
  
    ggplot2::ggplot(file,
        ggplot2::aes(x = colx, y = coly)) +
    ggplot2::geom_violin(fill = "seagreen2") +
    ggplot2::geom_boxplot(width = 0.1, fill = "sandybrown") +
    ggplot2::theme_minimal() + #get rid of grey background and tick marks
    ggplot2::theme(legend.position="none") + #remove legend
    ggplot2::theme(
      axis.text.x = ggplot2::element_text(vjust = 1, hjust = .5, size = 8),
      axis.text.y = ggplot2::element_text(size = 5),
      plot.title = ggplot2::element_text(hjust = 0.5, size = 12),
      plot.subtitle = ggplot2::element_text(hjust = 0.5, size = 12)) +
    #theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
    ggplot2::labs(title=title,
         subtitle=subtitle,
         caption = caption,
         x = xlab, y = ylab)
  #subregion_exsp
  
}

subregion_var_violin(geo_eccc, 'Plotting Subregion by Exotic_species', 'ECCC Data Paper', geo_eccc$Subregion, geo_eccc$Exotic_species, "Subregion", "Exotic_species", "Chart by Wendy Anthony \n 2025-08-04")
subregion_var_violin(geo_eccc,'Plotting Subregion by Cultural_species_richness', 'ECCC Data Paper', geo_eccc$Subregion, geo_eccc$Cultural_species_richness, "Subregion", "Cultural_species_richness", "Chart by Wendy Anthony \n 2025-08-16")

```

## Point Chart Function
### ggplot point chart
```{r Test-GGplot-Function-point}
geo_eccc <- read.csv("SiteData-TEST-GOE-Monitor.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)

str(geo_eccc)
names(geo_eccc)


subregion_var_point <- function(file, title, subtitle, colx, coly, xlab, ylab, caption){

ggplot(file, 
                    aes(x = colx, y = coly, colour = Subregion)) +
                    geom_point(shape = 18, size = 2) +
    # Replace default palette of pink & blue
    scale_fill_brewer(palette = "Dark2") +
                    theme_minimal() + #get rid of grey background and tick marks
                    theme(legend.position="bottom") +
                    # theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle =35, vjust = 1, hjust=1, size = 7)) +
                    labs(title=title,
                      subtitle=subtitle,
                      caption = caption,
                      x = xlab, y = ylab)
}

subregion_var_point(geo_eccc,'Plotting Site by Percentage Native Species', 'Malloff & Shackelford. (2024). \nFeeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. \nRestoration Futures Lab at the University of Victoria.
', geo_eccc$Site, geo_eccc$Proportion_of_native_species, "Site", "Proportion of native species", "Chart by Wendy Anthony \n 2025-09-16 \n ECCC Data: (Malloff & Shackelford, 2024)")

subregion_var_point(geo_eccc,'Plotting Site by Exotic Species', 'Malloff & Shackelford. (2024). \nFeeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. \nRestoration Futures Lab at the University of Victoria.
', geo_eccc$Site, geo_eccc$Exotic_species, "Site", "Exotic Species", "Chart by Wendy Anthony \n 2025-09-16 \n ECCC Data: (Malloff & Shackelford, 2024)")
```

### plotly ggplot point chart
```{r Test-GGplot-Function-point-plotly}
geo_eccc <- read.csv("SiteData-TEST-GOE-Monitor.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)

str(geo_eccc)
names(geo_eccc)


subregion_var_point <- function(file, title, subtitle, colx, coly, xlab, ylab, caption){

ggplot(file, 
                    aes(x = colx, y = coly, colour = Subregion)) +
                    geom_point(shape = 18, size = 2) +
    # Replace default palette of pink & blue
    scale_fill_brewer(palette = "Dark2") +
                    theme_minimal() + #get rid of grey background and tick marks
                    theme(legend.position="bottom") +
                    # theme(legend.position="none") + #remove legend 
                    theme(axis.text.x = element_text(angle =35, vjust = 1, hjust=1, size = 7)) +
                    labs(title=title,
                      subtitle=subtitle,
                      caption = caption,
                      x = xlab, y = ylab)
}

p2 <- subregion_var_point(geo_eccc,'Plotting Site by Percentage Native Species', 'Malloff & Shackelford. (2024). \nFeeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. \nRestoration Futures Lab at the University of Victoria.
', geo_eccc$Site, geo_eccc$Proportion_of_native_species, "Site", "Proportion of native species", "Chart by Wendy Anthony \n 2025-09-16 \n ECCC Data: (Malloff & Shackelford, 2024)")

subregion_var_point(geo_eccc,'Plotting Site by Exotic Species', 'Malloff & Shackelford. (2024). \nFeeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. \nRestoration Futures Lab at the University of Victoria.
', geo_eccc$Site, geo_eccc$Exotic_species, "Site", "Exotic Species", "Chart by Wendy Anthony \n 2025-09-16 \n ECCC Data: (Malloff & Shackelford, 2024)")

ggplotly(p2)

```


# Leaflet Map
## Custom Icons
```{r leaflet-map-custom-icons}

Sites_eccc <- read.csv("SiteDetails-TEST-GOE-Monitor.csv", header = TRUE, sep = ",")

names(Sites_eccc)

library(dplyr)
library(leaflet)
library(htmlwidgets) # for responsive web map

# custom icon
# https://leafletjs.com/examples/custom-icons/
greenLeafIcon <- makeIcon(
  iconUrl = "https://leafletjs.com/examples/custom-icons/leaf-green.png",
  iconWidth = 38, iconHeight = 95,
  iconAnchorX = 22, iconAnchorY = 94,
  shadowUrl = "https://leafletjs.com/examples/custom-icons/leaf-shadow.png",
  shadowWidth = 50, shadowHeight = 64,
  shadowAnchorX = 4, shadowAnchorY = 62
)
# change LeafIcon size 1/2
greenLeafIconSm <- makeIcon(
  iconUrl = "https://leafletjs.com/examples/custom-icons/leaf-green.png",
  iconWidth = 19, iconHeight = 47,
  iconAnchorX = 11, iconAnchorY = 47,
  shadowUrl = "https://leafletjs.com/examples/custom-icons/leaf-shadow.png",
  shadowWidth = 25, shadowHeight = 32,
  shadowAnchorX = 2, shadowAnchorY = 31
)

# Title control
title <- tags$div(HTML('<b>ECC Site Maps</b><br>Malloff & Shackelford. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria'))
  

ECCC_map <- leaflet(Sites_eccc) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addMarkers(
             ~ Lng, ~ Lat, icon = greenLeafIconSm,
             popup = paste0("<b>Subregion:</b> ", Sites_eccc$Subregion, "<br>", "<b>Site:</b> ", Sites_eccc$Site, "<br>", "<b>Latitude:</b> ", Sites_eccc$Lat, "<br>", "<b>Longitude:</b> ", Sites_eccc$Lng,  "<br><br>", "<b>Land Manager:</b> ", Sites_eccc$Land.Manager, "<br>", "<b>Main Restoration:</b> ", Sites_eccc$Main.Restoration.Type, "<br>", "<b>Restoration Intensity:</b> ", Sites_eccc$Restoration.Intensity, "<br>", "<b> Area:</b> ", Sites_eccc$Area.ha, " ha")) %>%
  setView(-123.44799, 48.64919, 9) %>%
  addMiniMap(width = 150, height = 150, zoomLevelOffset = -4) %>%
  addControl(title, position = "topright")

# Display map
ECCC_map

# Save map
saveWidget(ECCC_map, "ECCC_map.html")

```

## Circle Markers
```{r leaflet-map-circle-markers}

# NOT WORKING - Sites not same
#geo_eccc_sites <- cbind(geo_eccc, Sites_eccc)
# try to add , "<br>",  "<b>Composite Index:</b> ", geo_eccc_sites$Composite_Index
# names(geo_eccc_sites)
names(Sites_eccc)

library(dplyr)
library(leaflet)
library(htmlwidgets) # for responsive web map


# Title control
title <- tags$div(HTML('<b>ECC Site Maps</b><br>Malloff & Shackelford. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria'))
 
# https://rstudio.github.io/leaflet/articles/markers.html 
# Create a palette that maps factor levels to colors
pal <- colorFactor(c("green", "orange"), domain = c("Saanich Peninsula", "Gulf Islands"))

ECCC_map <- leaflet(Sites_eccc) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(
             ~ Lng, ~ Lat, radius = ~ifelse(Subregion == "Saanich Peninsula", 4, 5),
    color = ~pal(Subregion),
    stroke = FALSE, fillOpacity = 0.5,
             popup = paste0("<b>Site:</b> ", Sites_eccc$Site, "<br>", "<b>Subregion:</b> ", Sites_eccc$Subregion, "<br>", "<b>Latitude:</b> ", Sites_eccc$Lat, "<br>", "<b>Longitude:</b> ", Sites_eccc$Lng,  "<br><br>", "<b>Land Manager:</b> ", Sites_eccc$Land.Manager, "<br>", "<b>Main Restoration:</b> ", Sites_eccc$Main.Restoration.Type, "<br>", "<b>Restoration Intensity:</b> ", Sites_eccc$Restoration.Intensity, "<br>", "<b> Area:</b> ", Sites_eccc$Area.ha, " ha")) %>%
  setView(-123.44799, 48.64919, 9) %>%
  addMiniMap(width = 150, height = 150, zoomLevelOffset = -4) %>%
  addControl(title, position = "topright")

# Display map
ECCC_map

# Save map
saveWidget(ECCC_map, "ECCC_map.html")

```

## Circle Markers Sized to Area
```{r leaflet-map-circle-markers-sized-area}

names(Sites_eccc)

library(dplyr)
library(leaflet)
library(htmlwidgets) # for responsive web map


# Title control
# Malloff & Shackelford. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria
title <- tags$div(HTML('<p style="font-size:12px;font-weight:bold">ECC Sites Map</p>'))
 
# https://rstudio.github.io/leaflet/articles/markers.html 
# Create a palette that maps factor levels to colors
pal <- colorFactor(c("green", "orange"), domain = c("Saanich Peninsula", "Gulf Islands"))

ECCC_map <- leaflet(Sites_eccc) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(
             ~ Lng, ~ Lat, 
# https://stackoverflow.com/questions/40137212/variable-marker-size-feature-in-leaflet-r
              radius = ~geo_eccc$Composite_Index * 3,    
              # radius = ~Sites_eccc$Area.ha,
                  # radius = ~sqrt(Sites_eccc$Area.ha),
 # size smaller is Saanich, else larger if Gulf            
#             radius = ~ifelse(Subregion == "Saanich Peninsula", 4, 5),
    color = ~pal(Subregion),
    stroke = FALSE, fillOpacity = 0.5,
             popup = paste0("<b>Site:</b> ", Sites_eccc$Site, "<br>", "<b>Subregion:</b> ", Sites_eccc$Subregion, "<br>", "<b>Latitude:</b> ", Sites_eccc$Lat, "<br>", "<b>Longitude:</b> ", Sites_eccc$Lng,  "<br><br>", "<b>Land Manager:</b> ", Sites_eccc$Land.Manager, "<br>", "<b>Main Restoration:</b> ", Sites_eccc$Main.Restoration.Type, "<br>", "<b>Restoration Intensity:</b> ", Sites_eccc$Restoration.Intensity, "<br>", "<b> Area:</b> ", Sites_eccc$Area.ha, " ha")) %>%
  setView(-123.44799, 48.64919, 9) %>%
  addMiniMap(width = 150, height = 150, zoomLevelOffset = -4) %>%
  addControl(title, position = "topright")

# Display map
ECCC_map

# Save map
saveWidget(ECCC_map, "ECCC_map.html")

```


## Circle Markers Sized to Composite_Index
geo_eccc_all_site_data.csv
```{r leaflet-map-circle-markers-sized-Composite-Index}

geo_eccc_sites_1 <- read.csv("geo_eccc_all_site_data.csv")
names(geo_eccc_sites_1)

library(dplyr)
library(leaflet)
library(htmlwidgets) # for responsive web map


# Title control
# Malloff & Shackelford. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria
title <- tags$div(HTML('<p style="font-size:12px;font-weight:bold">ECC Sites Map</p>'))
 
# https://rstudio.github.io/leaflet/articles/markers.html 
# Create a palette that maps factor levels to colors
pal <- colorFactor(c("#d7191c", "#2c7bb6"), domain = c("Saanich Peninsula", "Gulf Islands"))

ECCC_map_1 <- leaflet(geo_eccc_sites_1) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(
             ~ Lng, ~ Lat, 
# https://stackoverflow.com/questions/40137212/variable-marker-size-feature-in-leaflet-r
              radius = ~geo_eccc_sites_1$Composite_Index * 5,    
              # radius = ~geo_eccc_sites_1$Area.ha,
                  # radius = ~sqrt(geo_eccc_sites_1$Area.ha),
 # size smaller is Saanich, else larger if Gulf            
#             radius = ~ifelse(Subregion == "Saanich Peninsula", 4, 5),
    fillColor = ~pal(Subregion),
    color = "black",
    weight = 3, # size of circle border
    stroke = TRUE, fillOpacity = 0.5,
             popup = paste0("<b>Site:</b> ", "<b>", "<b>", geo_eccc_sites_1$Site, "</b>", "</b>", "<br><br>", "<b>Subregion:</b> ", geo_eccc_sites_1$Subregion, "<br>",
                        "<b>Latitude:</b> ", geo_eccc_sites_1$Lat, "<br>", "<b>Longitude:</b> ", geo_eccc_sites_1$Lng,  "<br><br>",
                        "<b>Land Manager:</b> ", geo_eccc_sites_1$Land_Manager, "<br>",
                        "<b>Main Restoration:</b> ", geo_eccc_sites_1$Main_Restoration_Type, "<br>",
                        "<b>Restoration Intensity:</b> ", geo_eccc_sites_1$Restoration_Intensity, "<br>",
                        "<b> Area:</b> ", geo_eccc_sites_1$Area_ha, " ha",
                        "<br><br>",
                        "<b>Proportion of native species:</b> ", geo_eccc_sites_1$Proportion_of_native_species, "<br>",
                        "<b>Cultural species richness:</b> ", geo_eccc_sites_1$Cultural_species_richness, "<br>",
                        "<b>Exotic species:</b> ", geo_eccc_sites_1$Exotic_species, "<br>",
                        "<b>Trampling:</b> ", geo_eccc_sites_1$Trampling, "<br>",
                        "<b>Herbivory:</b> ", geo_eccc_sites_1$Herbivory, "<br>",
                        "<b>Composite Index:</b> ", geo_eccc_sites_1$Composite_Index, "<br>")) %>%
  setView(-123.44799, 48.64919, 10) %>%
  addMiniMap(width = 150, height = 150, zoomLevelOffset = -4) %>%
  addControl(title, position = "topright")

# Display map
ECCC_map_1

# Save map
saveWidget(ECCC_map_1, "ECCC_map_CI.html")

```

## Circle Markers Sized to Radius
### Title code
geo_eccc_all_site_data.csv
```{r leaflet-map-circle-markers-sized-radius}

geo_eccc_sites_1 <- read.csv("geo_eccc_all_site_data.csv")
names(geo_eccc_sites_1)

library(dplyr)
library(leaflet)
library(htmlwidgets) # for responsive web map


# Title control
# Malloff & Shackelford. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria
title <- '<p style="text-align: center; height: 30px; ">
<span style="font-size:10px;font-weight:bold; background-color: rgba(255, 255, 255, 0.9;");>ECCC GOE 2023 Monitoring Sites</span><br>
<span style="font-size:8px;font-style:italic; background-color: rgba(255, 255, 255, 0.9;">(Malloff & Shackelford, 2024)</span></p>'
 
# https://rstudio.github.io/leaflet/articles/markers.html 
# Create a palette that maps factor levels to colors
pal <- colorFactor(c("#d7191c", "#2c7bb6"), domain = c("Saanich Peninsula", "Gulf Islands"))

ECCC_map_2 <- leaflet(geo_eccc_sites_1) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(
             ~ Lng, ~ Lat, 
# https://stackoverflow.com/questions/40137212/variable-marker-size-feature-in-leaflet-r
#              radius = ~geo_eccc_sites_1$Composite_Index * 5,    
              # radius = ~geo_eccc_sites_1$Area.ha,
                  # radius = ~sqrt(geo_eccc_sites_1$Area.ha),
 # size smaller is Saanich, else larger if Gulf            
             radius = ~ifelse(Subregion == "Saanich Peninsula", 8, 8),
    fillColor = ~pal(Subregion),
    color = "black",
    weight = 3, # size of circle border
    stroke = TRUE, fillOpacity = 0.5,
             popup = paste0("<b>ECCC GOE 2023 Monitoring Data</b>", "<br>", "<i>(Malloff & Shackelford, 2024)</i>", "<br><br>",
               "<b>Site:</b> ", "<b>", geo_eccc_sites_1$Site, "</b>", "</b>", "<br><br>", "<b>Subregion:</b> ", geo_eccc_sites_1$Subregion, "<br>",
                        "<b>Latitude:</b> ", geo_eccc_sites_1$Lat, "<br>", "<b>Longitude:</b> ", geo_eccc_sites_1$Lng,  "<br><br>",
                        "<b>Land Manager:</b> ", geo_eccc_sites_1$Land_Manager, "<br>",
                        "<b>Main Restoration:</b> ", geo_eccc_sites_1$Main_Restoration_Type, "<br>",
                        "<b>Restoration Intensity:</b> ", geo_eccc_sites_1$Restoration_Intensity, "<br>",
                        "<b> Area:</b> ", geo_eccc_sites_1$Area_ha, " ha",
                        "<br><br>",
                        "<b>Proportion of native species:</b> ", geo_eccc_sites_1$Proportion_of_native_species, "<br>",
                        "<b>Cultural species richness:</b> ", geo_eccc_sites_1$Cultural_species_richness, "<br>",
                        "<b>Exotic species:</b> ", geo_eccc_sites_1$Exotic_species, "<br>",
                        "<b>Trampling:</b> ", geo_eccc_sites_1$Trampling, "<br>",
                        "<b>Herbivory:</b> ", geo_eccc_sites_1$Herbivory, "<br>",
                        "<b>Composite Index:</b> ", geo_eccc_sites_1$Composite_Index, "<br>")) %>%
  setView(-123.44799, 48.64919, 10) %>%
  # add controls
  addMiniMap(width = 150, height = 150, zoomLevelOffset = -4) %>%
  addControl(title, position = "topright")

# Display map
ECCC_map_2

# Save map
saveWidget(ECCC_map_2, "ECCC_map_radius-1.html")

```

---

# Shiny 
## Shiny Gadget
### lmGadget all sites
- code works but can't knit html file unless
adding "echo=TRUE, eval = FALSE"
```{r shiny-lmgadget, echo=FALSE, eval = FALSE}
# colnames(geo_eccc_1)

library(shiny)
library(miniUI)
library(ggplot2)


lmGadget <- function(data, xvar, yvar) {

  ui <- miniPage(
    gadgetTitleBar("Interactive lm"),
    miniContentPanel(
      fillRow(flex = c(NA, 1),
              fillCol(width = "100px",
                      selectInput("degree", "Polynomial degree", c(1, 2, 3, 4))
              ),
              plotOutput("plot1",
                         height = "100%",
                         click = "plot1_click",
                         brush = brushOpts(
                           id = "plot1_brush"
                         )
              )
      )
    ),
    miniButtonBlock(
      actionButton("exclude_toggle", "Toggle points"),
      actionButton("exclude_reset", "Reset")
    )
  )

  server <- function(input, output) {
    # For storing which rows have been excluded
    vals <- reactiveValues(
      keeprows = rep(TRUE, nrow(data))
    )

    output$plot1 <- renderPlot({
      req(input$degree)
      formula <- as.formula(paste0("y ~ poly(x, degree = ", input$degree, ")"))

      # Plot the kept and excluded points as two separate data sets
      keep    <- data[ vals$keeprows, , drop = FALSE]
      exclude <- data[!vals$keeprows, , drop = FALSE]

      ggplot(keep, aes_string(xvar, yvar)) + geom_point() +
        geom_smooth(method = lm, formula = formula, fullrange = TRUE, color = "gray50") +
        geom_point(data = exclude, fill = NA, color = "black", alpha = 0.25) +
        coord_cartesian(xlim = range(data[[xvar]]), ylim = range(data[[yvar]])) +
        theme_bw(base_size = 14)
    })

    # Toggle points that are clicked
    observeEvent(input$plot1_click, {
      res <- nearPoints(data, input$plot1_click, allRows = TRUE)

      vals$keeprows <- xor(vals$keeprows, res$selected_)
    })

    # Toggle points that are brushed, when button is clicked
    observeEvent(input$exclude_toggle, {
      res <- brushedPoints(data, input$plot1_brush, allRows = TRUE)

      vals$keeprows <- xor(vals$keeprows, res$selected_)
    })

    # Reset all points
    observeEvent(input$exclude_reset, {
      vals$keeprows <- rep(TRUE, nrow(data))
    })

    # Handle the Done button being pressed.
    observeEvent(input$done, {
      # Replace x and y in the formula with the values in xvar and yvar
      formula <- as.formula(paste0(yvar, " ~ poly(", xvar, ", degree = ", input$degree, ")"))
      keep_data <- data[vals$keeprows, , drop = FALSE]

      # Return the kept points.
      stopApp(
        list(
          data = keep_data,
          model = lm(formula, keep_data)
        )
      )
    })

  }

    runGadget(ui, server, viewer = dialogViewer("lmGadget")) # separate viewer window
}

lmGadget(geo_eccc_1, "Percentage_ns", "Composite_Index")
lmGadget(iris, "Sepal.Length", "Sepal.Width")
```



## Inline Shiny app 


### Shiny Showcase
`app-WORKS-TabsetLayout-choose-Reactive-Table-Plot-BoxNames-comments-showcase.R`
```{r, Shiny-app-inline-showcase, echo=FALSE, eval = TRUE}
# Download data
geo_eccc_sites_2 <- read.csv("geo_eccc_all_site_data.csv", header = TRUE, sep = ",")

# Package Libraries
library(shiny)
library(leaflet)
library(ggplot2)
library(plotly)

#ui
shinyApp(
ui = fluidPage(
  # app Title
  titlePanel("Exploring GOE Monitoring Dataviz"),
sidebarLayout(
  # sidebarPanel
  sidebarPanel(width = 3,
    selectInput("Menu1","Choose a Subregion", choices = c("All", unique(geo_eccc_sites_2$Subregion))),
    selectInput("Menu2","Choose an Site", choices = c("All", unique(geo_eccc_sites_2$Site))),
    span(style = "font-weight:bold; font-size:11px;", "Using App: "),
    span(style = "font-size:10px;", "Choose all or one Subregion and/or Site, then click tab to view results: Table, Comparing Subregions, and Comparing Sites"),
    br(),
    span(style = "font-weight:bold; font-size:11px;", "About the Data: "),
    span(style = "font-size:9px;", "GOE Data from report tables: Malloff, J., & Shackelford, N. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria.
")
  ),
  # mainPanel
  mainPanel(
    # tabsetPanel
tabsetPanel(
  id = "tabset",
  selected = "About This App",
tabPanel("About This App",  htmlOutput("text")),
tabPanel("Data Table", p(style = "font-size:9px;", "GOE Data from report tables: Malloff, J., & Shackelford, N. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria.
"), tableOutput("table1")),
tabPanel("Comparing Subregions",
         p(style = "font-size:9px;", "GOE Data from report tables: Malloff, J., & Shackelford, N. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria.
"),
         fluidRow(
            column(6, plotOutput("plot2")),
            #column(6, plotOutput("plot3")),
            #column(6, plotOutput("plot8")),
            column(6, plotOutput("plot9"))
         )),
# tabs seem to break if I tryto reuse plot
tabPanel("Comparing Sites",
         p(style = "font-size:9px;", "GOE Data from report tables: Malloff, J., & Shackelford, N. (2024). Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems. Restoration Futures Lab at the University of Victoria.
"),
         fluidRow(
           column(6, plotlyOutput("plot5")),
           column(6, plotlyOutput("plot10")),
           column(6, plotlyOutput("plot6")),
           column(6, plotlyOutput("plot11"))
         ))
#,
# tabPanel("Plot Output",  plotOutput("plot")),
# tabPanel("Subregion Plots Output",  plotOutput("plot2")),
# tabPanel("Comparing Site Plots Output",  plotOutput("plot4")),
# tabPanel("More Subregion Plots Output",  plotOutput("plot5")),
# tabPanel("More Subregion Plots Output",  plotOutput("plot6")),
# tabPanel("Plotly Output",  plotlyOutput("plot7"))
# ,
# tabPanel("Map Output",  leafletOutput("map",height = 650,width=605))

# end tabsetPanel
)
# end mainPanel
  )
# end sidebarLayout
)
# end Fluid Page
),

# server
server = function(input, output, session){

  data_1 <- reactive({
    if(input$Menu1 == "All"){
      geo_eccc_sites_2
    }else{
      geo_eccc_sites_2[which(geo_eccc_sites_2$Subregion == input$Menu1),]
    }
  })

  data_2 <- reactive({
    if (input$Menu2 == "All"){
      geo_eccc_sites_2
    }else{
      geo_eccc_sites_2[which(geo_eccc_sites_2$Site == input$Menu2),]
    }
  })

  observe({
    if(input$Menu1 != "All"){
      updateSelectInput(session,"Menu2","Choose a Site", choices = c("All",unique(data_1()$Site)))
    }
    else if(input$Menu2 != 'All'){
      updateSelectInput(session,"Menu1","Choose a name", choices = c('All',unique(data_2()$Subregion)))
    }
    else if (input$Menu1 == "All" & input$Menu2 == "All"){
      updateSelectInput(session,"Menu2","Choose a Site", choices = c('All',unique(geo_eccc_sites_2$Site)))
      updateSelectInput(session,"Menu1","Choose a Subregion", choices = c('All',unique(geo_eccc_sites_2$Subregion)))
    }
  })


  data3 <- reactive({
    if(input$Menu2 == "All"){
      data_1()
    }else if (input$Menu1 == "All"){
      data_2()
    }else if (input$Menu2 == "All" & input$Menu1 == "All"){
      geo_eccc_sites_2
    }
    else{
      geo_eccc_sites_2[which(geo_eccc_sites_2$Site == input$Menu2 & geo_eccc_sites_2$Subregion == input$Menu1),]
    }
  })


  # text output
  # https://stackoverflow.com/questions/23233497/outputting-multiple-lines-of-text-with-rendertext-in-r-shiny
  # https://stackoverflow.com/questions/33392784/make-bold-text-in-html-output-r-shiny
  output$text <- renderUI({
    str1 <- paste("for HAT's GOE Monitoring Data")
    str2 <- paste("Here is what I propose to offer ...")
    str3 <- paste("I. Final Products")
    str3a <- paste("Shiny Interactive Dataviz Tool, RMarkdown Code Document that cleans data, and creates dataviz")
    str4 <- paste("II. Data Preparation")
    str4a <- paste("Clean data, ensure consistent naming and data formats, saving outputs, storing data")
    str5 <- paste("III. Interactive Data Tables")
    str5a <- paste("Filter by Subregion Group or Site; Search; Save Results")
    str6 <- paste("IV. Plots")
    str6a <- paste("Dot plots, bar charts, violin plots, Individual Sites, Subregion Group, save results")
    str7 <- paste("V. Maps")
    str7a <- paste("With markers sized equally, or by a variable value, ")
    str7b <- paste('<a href="https://wendyanthony.github.io/ECCC_map_radius-1.html" target="_blank">Interactive Webpage Leaflet Map</a>')
    HTML(paste0('<H2>', "Proposed Interactive Data Viz Tool", '</H2>',
                '<H3>', str1, '</H3>',
                str2, '<br/>',
                '<H4>', str3, '</H4>',
                ' ', str3a, '<br/>',
                '<H4>', str4, '</H4>',
                ' ', str4a, '<br/>',
                '<H4>', str5, '</H4>',
                ' ', str5a, '<br/>',
                '<H4>', str6, '</H4>',
                ' ', str6a, '<br/>',
                '<H4>', str7, '</H4>',
                ' ', str7a, str7b, '<br/>'
                ))
  })

  # table output
  output$table1 <- renderTable({
    data3()
  })

# Plot works
# output$plot <- renderPlot({
#   d <- data3()
#   plot(d$Exotic_species,d$Composite_Index)
# })


# Plot works
output$plot <- renderPlot({
  d <- data3()
  ggplot(d,
         aes(x = Site, y = Percentage_ns)) +
    geom_point(shape = 18, size = 2) +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="none") + #remove legend
    theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
    labs(title='Plotting Site by Percentage Native Species',
         subtitle='ECCC (Malloff & Shackelford, 2024)',
         caption = "Chart by Wendy Anthony \n 2025-08-04")
})

# Plot works
output$plot2 <- renderPlot({
  d <- data3()

  ggplot(d,
         aes(x = Subregion, y = Exotic_species)) +
    geom_violin(fill = "seagreen2") +
    geom_boxplot(width = 0.1, fill = "sandybrown") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="none") + #remove legend
    theme(axis.text.x = element_text(vjust = 1, size = 9)) +
    labs(title='Plotting Subregion by Exotic Species',
         subtitle='ECCC (Malloff & Shackelford, 2024)',
         caption = "Chart by Wendy Anthony \n 2025-08-04")
})


# Plot works
output$plot3 <- renderPlot({
  d <- data3()

  ggplot(d,
         aes(x = Subregion, y = Composite_Index)) +
    geom_violin(fill = "seagreen2") +
    geom_boxplot(width = 0.1, fill = "sandybrown") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="none") + #remove legend
    theme(axis.text.x = element_text(vjust = 1, size = 9)) +
    labs(title='Plotting Subregion by Composite_Index',
         subtitle='ECCC (Malloff & Shackelford, 2024)',
         caption = "Chart by Wendy Anthony \n 2025-08-04")
})

# Plot works
output$plot8 <- renderPlot({
  d <- data3()

  ggplot(d,
         aes(x = Subregion, y = Cultural_species_richness)) +
    geom_violin(fill = "seagreen2") +
    geom_boxplot(width = 0.1, fill = "sandybrown") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="none") + #remove legend
    theme(axis.text.x = element_text(vjust = 1, size = 9)) +
    labs(title='Plotting Subregion by Cultural_species_richness',
         subtitle='ECCC (Malloff & Shackelford, 2024)',
         caption = "Chart by Wendy Anthony \n 2025-08-04")
})

# Plot works
output$plot9 <- renderPlot({
  d <- data3()
names(geo_eccc_sites_2)
  ggplot(d,
         aes(x = Subregion, y = Percentage_ns)) +
    geom_violin(fill = "seagreen2") +
    geom_boxplot(width = 0.1, fill = "sandybrown") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="none") + #remove legend
    theme(axis.text.x = element_text(vjust = 1, size = 9)) +
    labs(title='Plotting Subregion by Percentage Native Species',
         subtitle='ECCC (Malloff & Shackelford, 2024)',
         caption = "Chart by Wendy Anthony \n 2025-08-04")
})


# Plot works
output$plot4 <- renderPlot({
  d <- data3()

  d %>% arrange(desc(Percentage_ns)) %>%
    # updates Site with new arrangement
    mutate(Site = factor(Site, levels = Site)) %>%
    ggplot(
      aes(x = Site, y = Percentage_ns, fill = Subregion, color = Subregion)) +
    # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
    ylim(0, 100) +
    geom_bar(stat = "identity") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust=1, size = 7)) +
    labs(title='Comparinging Sites by Percentage Native Species',
         subtitle='ECCC GOE Site Monitoring',
         caption = "Chart by Wendy Anthony \n 2025-08-19")
})


# Plot works
output$plot5 <- renderPlotly({
  d <- data3()

  d %>% arrange(desc(Exotic_species)) %>%
    # updates Site with new arrangement
    mutate(Site = factor(Site, levels = Site)) %>%
    ggplot(
      aes(x = Site, y = Exotic_species, fill = Subregion, color = Subregion)) +
    # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
    ylim(0, 100) +
    geom_bar(stat = "identity") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust=1, size = 7)) +
    labs(title='Comparing Sites by Exotic Species (High-Low)',
         subtitle='ECCC GOE Site Monitoring',
         caption = "Chart by Wendy Anthony \n 2025-08-19")
})



# Plot works
output$plot6 <- renderPlotly({
  d <- data3()

  d %>% arrange(desc(Percentage_ns)) %>%
    # updates Site with new arrangement
    mutate(Site = factor(Site, levels = Site)) %>%
    ggplot(
      aes(x = Site, y = Percentage_ns, fill = Subregion, color = Subregion)) +
    # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
    ylim(0, 100) +
    geom_bar(stat = "identity") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust=1, size = 7)) +
    labs(title='Compare Sites by % Native Species (High-Low)',
         subtitle='ECCC GOE Site Monitoring',
         caption = "Chart by Wendy Anthony \n 2025-08-19")
})


# Plot works
output$plot10 <- renderPlotly({
  d <- data3()

  # d %>% arrange(desc(Exotic_species)) %>%
  #   # updates Site with new arrangement
  #   mutate(Site = factor(Site, levels = Site)) %>%
  d %>% ggplot(
      aes(x = Site, y = Exotic_species, fill = Subregion, color = Subregion)) +
    # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
    ylim(0, 100) +
    geom_bar(stat = "identity") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust=1, size = 7)) +
    labs(title='Compare Sites by Exotic Species (alpha)',
         subtitle='ECCC GOE Site Monitoring',
         caption = "Chart by Wendy Anthony \n 2025-08-19")
})



# Plot works
output$plot11 <- renderPlotly({
  d <- data3()

  # d %>% arrange(desc(Herbivory)) %>%
  #   # updates Site with new arrangement
  #   mutate(Site = factor(Site, levels = Site)) %>%
  d %>% ggplot(
      aes(x = Site, y = Percentage_ns, fill = Subregion, color = Subregion)) +
    # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
    ylim(0, 100) +
    geom_bar(stat = "identity") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust=1, size = 7)) +
    labs(title='Compare Sites by % Native Species (alpha)',
         subtitle='ECCC GOE Site Monitoring',
         caption = "Chart by Wendy Anthony \n 2025-08-19")
})

# Plot works
output$plot7 <- renderPlotly({
  d <- data3()

  d %>% arrange(desc(Herbivory)) %>%
    # updates Site with new arrangement
    mutate(Site = factor(Site, levels = Site)) %>%
    ggplot(
      aes(x = Site, y = Herbivory, fill = Subregion, color = Subregion)) +
    # https://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
    ylim(0, 100) +
    geom_bar(stat = "identity") +
    theme_minimal() + #get rid of grey background and tick marks
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust=1, size = 7)) +
    labs(title='Comparinging Sites by Herbivory',
         subtitle='ECCC GOE Site Monitoring',
         caption = "Chart by Wendy Anthony \n 2025-08-19")
})

# # Create the base map
# output$map <- renderLeaflet({
#   leaflet() %>%
#     addProviderTiles("Esri.WorldImagery") %>%
#     setView(-123.44799, 48.64919, 9) # Center of US
# })
#
# # Observer to update markers when filtered data changes
# observe({
#   data <- data3()
#
#   leafletProxy("map") %>%
#     clearMarkers() %>%  # Remove existing markers
#     addCircleMarkers(
#       color = ~pal(Subregion),
#       # size by multiple of Composite_Index
#       radius = ~Composite_Index * 5,
#       stroke = FALSE, fillOpacity = 0.5,
#       data = data,
#       lng = ~Lng,
#       lat = ~Lat,
#       popup = ~paste0("<b>Site:</b> ", "<b>", Site, "</b>", "<br><br>", "<b>Subregion:</b> ", Subregion, "<br>",
#                       "<b>Latitude:</b> ", Lat, "<br>", "<b>Longitude:</b> ", Lng,  "<br><br>",
#                       "<b>Land Manager:</b> ", Land_Manager, "<br>",
#                       "<b>Main Restoration:</b> ", Main_Restoration_Type, "<br>",
#                       "<b>Restoration Intensity:</b> ", Restoration_Intensity, "<br>",
#                       "<b> Area:</b> ", Area_ha, " ha",
#                       "<br><br>",
#                       "<b>Proportion of native species:</b> ", Proportion_of_native_species, "<br>",
#                       "<b>Cultural species richness:</b> ", Cultural_species_richness, "<br>",
#                       "<b>Exotic species:</b> ", Exotic_species, "<br>",
#                       "<b>Trampling:</b> ", Trampling, "<br>",
#                       "<b>Herbivory:</b> ", Herbivory, "<br>",
#                       "<b>Composite Index:</b> ", Composite_Index, "<br>"
#       )
#     )
# })

# end of server
}
)
#shinyApp(ui,server)
```

### Reactive choose 
```{r, Shiny-app-inline, echo=FALSE}
library(shiny)
geo_eccc <- read.csv("SiteData-TEST-GOE-Monitor.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)
colnames(geo_eccc)
str(geo_eccc)

shinyApp(

# https://stackoverflow.com/questions/44569739/r-shiny-how-to-make-selectinput-choices-reactive-to-each-other-while-subsetting




ui <-shinyUI(fluidPage(
  selectInput("Box1","Choose a Subregion", choices = c("All",unique(geo_eccc$Subregion))),
  selectInput("Box2","Choose an Site", choices = c("All",unique(geo_eccc$Site))),
  tableOutput("table1")
)), # include comma after ui


server <- shinyServer(function(input,output, session){

  data1 <- reactive({
    if(input$Box1 == "All"){
      geo_eccc
    }else{
      geo_eccc[which(geo_eccc$Subregion == input$Box1),]
    }
  })

  data2 <- reactive({
    if (input$Box2 == "All"){
      geo_eccc
    }else{
      geo_eccc[which(geo_eccc$Site == input$Box2),]
    }
  })

  observe({

    if(input$Box1 != "All"){
      updateSelectInput(session,"Box2","Choose an Site", choices = c("All",unique(data1()$Site)))
    }

    else if(input$Box2 != 'All'){
      updateSelectInput(session,"Box1","Choose a Subregion", choices = c('All',unique(data2()$Subregion)))
    }

    else if (input$Box1 == "All" & input$Box2 == "All"){
      updateSelectInput(session,"Box2","Choose an Site", choices = c('All',unique(geo_eccc$Site)))
      updateSelectInput(session,"Box1","Choose a Subregion", choices = c('All',unique(geo_eccc$Subregion)))
    }
  })


  data3 <- reactive({
    if(input$Box2 == "All"){
      data1()
    }else if (input$Box1 == "All"){
      data2()
    }else if (input$Box2 == "All" & input$Box1 == "All"){
      geo_eccc
    }
    else{
      geo_eccc[which(geo_eccc$Site== input$Box2 & geo_eccc$Subregion == input$Box1),]
    }
  })

  output$table1 <- renderTable({
    data3()
  })

})

)
```


### Leaflet Reactive Site Details
`app-leaflet-reactive-AllSiteDetails-WORKING`

```{r, Shiny-app-inline-leaflet, echo=FALSE}
## https://stackoverflow.com/questions/46979328/how-to-make-shiny-leaflet-map-react-to-change-in-input-value-r
# Map is filtering Subregion Sites, but drop down list isn't
# Modelled on `app-test-leaflet-reactive.R`
# Works 2025-08-18

library(shiny)
library(bslib)
library(leaflet)
library(dplyr)

############################################################
## Data
# note Restoration_Intensity column values all had a space in front of value - wasn't sorting properly ... changed
geo_eccc_sites <- read.csv("geo_eccc_all_site_data.csv", header = TRUE, sep = ",")
names(geo_eccc_sites)
str(geo_eccc_sites)

shinyApp(
############################################################
## UI
ui <- fluidPage(
  titlePanel("ECCC GOE Monitoring Sites Interactive Map"),
  tags$div(HTML('<p style="font-size:12px;"><b>Source:</b> Malloff & Shackelford. (2024).
  <i>Feeling the Pulse: Monitoring methods and initial outcomes in oak meadow ecosystems.</i>
                Restoration Futures Lab at the University of Victoria.</p>')),
  tags$div(HTML('<p style="font-size:12px;"><b>Note:</b> Marker size is based on Composite Index.</p>')),

    # Dropdown for Subregion
    selectInput(
      "Subregion_filter",
      "Select Subregion:",
      choices = c("All" = "all", unique(geo_eccc_sites$Subregion)),
      selected = "all"
    ),
  tags$div(HTML('<p style="font-size:12px;">Note: If selecting by Subregion,
                ensure Sites are All selected.</p>')),

    # Dropdown for Site
    selectInput(
      "Site_filter",
      "Select Site:",
      choices = c("All" = "all", unique(geo_eccc_sites$Site)),
      selected = "all"
  ),

    leafletOutput("map", height = "600px")
),

############################################################
## Server
server <- function(input, output, session) {

  pal <- colorFactor(c("green", "orange"), domain = c("Saanich Peninsula", "Gulf Islands"))
  # Reactive expression to filter data based on dropdown selections
  filtered_data <- reactive({
    data <- geo_eccc_sites

    # Filter by Subregion if not "all"
    if (input$Subregion_filter != "all") {
      data <- data %>% filter(Subregion == input$Subregion_filter)
    }

    # Filter by Site if not "all"
    if (input$Site_filter != "all") {
      data <- data %>% filter(Site == input$Site_filter)
    }

    return(data)
  })

  # Create the base map
  output$map <- renderLeaflet({
    leaflet() %>%
      addProviderTiles("Esri.WorldImagery") %>%
      setView(-123.44799, 48.64919, 9) # Center of US
  })

  # Observer to update markers when filtered data changes
  observe({
    data <- filtered_data()

    leafletProxy("map") %>%
      clearMarkers() %>%  # Remove existing markers
      addCircleMarkers(
        color = ~pal(Subregion),
        # size by multiple of Composite_Index
        radius = ~Composite_Index * 5,
        stroke = FALSE, fillOpacity = 0.5,
        data = data,
        lng = ~Lng,
        lat = ~Lat,
        popup = ~paste0("<b>Site:</b> ", "<b>", Site, "</b>", "<br><br>", "<b>Subregion:</b> ", Subregion, "<br>",
                        "<b>Latitude:</b> ", Lat, "<br>", "<b>Longitude:</b> ", Lng,  "<br><br>",
                        "<b>Land Manager:</b> ", Land_Manager, "<br>",
                        "<b>Main Restoration:</b> ", Main_Restoration_Type, "<br>",
                        "<b>Restoration Intensity:</b> ", Restoration_Intensity, "<br>",
                        "<b> Area:</b> ", Area_ha, " ha",
                        "<br><br>",
                        "<b>Proportion of native species:</b> ", Proportion_of_native_species, "<br>",
                        "<b>Cultural species richness:</b> ", Cultural_species_richness, "<br>",
                        "<b>Exotic species:</b> ", Exotic_species, "<br>",
                        "<b>Trampling:</b> ", Trampling, "<br>",
                        "<b>Herbivory:</b> ", Herbivory, "<br>",
                        "<b>Composite Index:</b> ", Composite_Index, "<br>"
                        )
      )
  })
}
)
#shinyApp(ui = ui, server = server)

```


### Datatable search plot 
`app-datatable-search-plot-update-ECCC-TEST`
https://stackoverflow.com/questions/52880657/in-an-shiny-app-i-want-a-plot-to-update-based-on-the-search-results-in-a-datat 
```{r, Shiny-app-inline-datatable, echo=FALSE}

library(shiny)
library(DT)

geo_eccc <- read.csv("geo_eccc_all_site_data.csv", header = TRUE, sep = ",", stringsAsFactors=FALSE)

shinyApp(
ui <- basicPage(
  h2("ECCC GOE Monitoring Data"),
  DT::dataTableOutput("mytable"),
  downloadButton("downloadData", label = "Download filtered table data"),
  tags$div(HTML("<br>")),
  verbatimTextOutput("test"),
  plotOutput('plot1')

),

server <- function(input, output) {

  mc <- geo_eccc # could be reactive in real world case

  output$mytable = DT::renderDataTable({
    datatable(mc, filter = 'top')
  })

  filtered_table <- reactive({
    req(input$mytable_rows_all)
    mc[input$mytable_rows_all, ]
  })

  output$plot1 <- renderPlot({
    plot(filtered_table()$Proportion_of_native_species, filtered_table()$Exotic_species, col = "green", lwd = 10)
    #    plot(filtered_table()$Proportion_of_native_species, filtered_table()$Exotic_species, col = "red", lwd = 10)
  })

  output$test <- renderPrint({
    filtered_table()
  })

  output$downloadData <- downloadHandler(
    filename = "myFile.csv",
    content = function(file){
      write.csv(filtered_table(), file)
    }
  )

}
)
# shinyApp(ui, server)

```


  ### Plot Select Axis Variables
`app4-SelectAxisVariables-WORKS.R`
- this shiny app won't knit - looses connection ???
```{r, Shiny_app_inline_, echo=FALSE}
#
# https://monashbioinformaticsplatform.github.io/R-ShinyIntro-MBP/tutorial.html
# https://github.com/MonashDataFluency/R-ShinyIntro/blob/master/ShinyApps/demo/demo_interactive.R

# https://monashbioinformaticsplatform.github.io/R-ShinyIntro-MBP/tutorial.html

library(shiny)
library(shinyscreenshot)
library(utils)
library(ggplot2)

# shinyscreenshot::runExample()
shinyApp(
ui <- fluidPage(
  titlePanel("Plotting ECCC GOE Monitoring Variables"),

  sidebarLayout(
    sidebarPanel(
      # set div for screenshot
        div(
          id = "input_panel",
          tags$b("Input sidebar panel selections"),
          selectInput(inputId = "x_select", label = "Select x-axis",
                      choices = list("Proportion_of_native_species",
                                     "Cultural_species_richness",
                                     "Exotic_species",
                                     "Trampling",
                                     "Herbivory",
                                     "Composite_Index"),
                      selected = "Exotic_species"),
          selectInput(inputId = "y_select", label = "Select y-axis",
                      choices = list("Proportion of native species" = "Proportion_of_native_species",
                                     "Cultural species richness" = "Cultural_species_richness",
                                     "Exotic species" = "Exotic_species",
                                     "Trampling 1" = "Trampling",
                                     "Herbivory 1" = "Herbivory",
                                     "Composite Index" = "Composite_Index"),
                      selected = "Proportion_of_native_species"),
        ),
        tags$div(HTML("<hr style='height:2px;border-width:0;color:gray;background-color:gray'>")),
## Screenshot buttons
                 tags$div(HTML("<b>Take Screenshots<br></b>")),
                 tags$div(HTML("<p style='font-size:10px;font-style:italic;'>(Note: Screenshots are saved to same location as Shiny app)</p>")),
                 screenshotButton(label = "Entire page", filename = "ECCC-Screenshot-entirePage", download = FALSE, server_dir="."),
                 screenshotButton(label = "Input panel", id = "input_panel", filename = "ECCC-Screenshot-inputPanel", download = FALSE, server_dir="."),
                 screenshotButton(label = "Plot 1", id = "my_plot", filename = "ECCC-Screenshot-plot1", download = FALSE, server_dir="."),
                 screenshotButton(label = "Plot 2", id = "my_plot1", filename = "ECCC-Screenshot-plot2", download = FALSE, server_dir=".")
    ),
    mainPanel(tags$b("Main panel Input Selections"),
              tags$div(HTML("<br>")),
              strong("X axis: "),
              textOutput(outputId = "check_x_select"),
              tags$div(HTML("<br>")),
              strong("Y axis: "),
              textOutput(outputId = "check_y_select"),
              #tags$div(HTML('<br><br>')),
              tags$div(HTML("<hr style='height:2px;border-width:0;color:gray;background-color:gray'>")),
              tags$div(HTML("<b>", "Plot1: Resulting ggplot by Site", "</b>")),
              plotOutput(outputId = "my_plot", width = 600, height = 600),
              tags$div(HTML("<hr style='height:2px;border-width:0;color:gray;background-color:gray'>")),
              tags$div(HTML("<b>", "Plot2: Resulting ggplot by Subregion", "</b>")),
              plotOutput(outputId = "my_plot1", width = 600, height = 600)
    )
  )
),

server <- function(input, output) {

  output$check_x_select <- renderText({
    print(input$x_select)
  })

  output$check_y_select <- renderText({
    print(input$y_select)
  })

  output$my_plot <- renderPlot({

    #Read in the sample csv
    dat <- read.csv("TEST-GOE-Monitor.csv")

    #Pull out a column for the x and y axis each
    x_axis <- dat[, input$x_select]
    y_axis <- dat[, input$y_select]

    #Create a basic dot plot
    #plot(x = x_axis, y_axis)

    # ggplot
    ggplot() +
           aes(x = x_axis, y_axis, color = dat$Site) +
      geom_point(shape = 18, size = 4) +
      theme_minimal() + #get rid of grey background and tick marks
      theme(legend.position="bottom") + #remove legend
      theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
      labs(title='Plotting Site Variables by Select Input',
           subtitle='ECCC GEO Monitoring Data',
           caption = "Chart by Wendy Anthony \n 2025-08-18",
            x = input$x_select, y = input$y_select,
           # legend title by variable used to colour
           color = "Site")
  })

  output$check_y_select <- renderText({
    print(input$y_select)
  })

  output$my_plot1 <- renderPlot({

    #Read in the sample csv
    dat <- read.csv("TEST-GOE-Monitor.csv")

    #Pull out a column for the x and y axis each
    x_axis <- dat[, input$x_select]
    y_axis <- dat[, input$y_select]

    #Create a basic dot plot
    #plot(x = x_axis, y_axis)

    # ggplot
    ggplot() +
      aes(x = x_axis, y_axis, color = dat$Subregion) +
      geom_point(shape = 18, size = 4) +
      theme_minimal() + #get rid of grey background and tick marks
      theme(legend.position="bottom") + #remove legend
      theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1, size = 7)) +
      labs(title='Plotting Subregion Variables by Select Input',
           subtitle='ECCC GEO Monitoring Data',
           caption = "Chart by Wendy Anthony \n 2025-08-18",
           x = input$x_select, y = input$y_select,
           # legend title by variable used to colour
           color = "Subregion")
  })

}
)
# shinyApp(ui = ui, server = server)

```




# Mermaid Methods Flow Chart
## Flow for ER390 Monitoring Data 
```{r diagramr-Wendy-Hat-Tech-Data}
DiagrammeR("
sequenceDiagram;
   Wendy->>HAT: ask for data;
   database->>HAT: monitoring data;
   database->>RStudio: upload and filter data;
   RStudio->>HAT: Report;
   HAT->>Wendy: data;
   alt monitoring data available
     RestorationTech->>database: upload data;
     RestorationTech->>Site: monitor;
     Site->>database: Site Monitoring Data;
     RStudio->>database: query data;
     Wendy->>RStudio: create data viz code;
   else data unavailable
     database->>RestorationTech: data not available;
     RestorationTech->>Site: remonitor;
     RestorationTech->>SiteCommunity: ask to remonitor;
     SiteCommunity->>RestorationTech: OK to remonitor;
   end
")

```

##  Graph for ER390 Methods Workflow
```{r ER390-mermaid-graph-shapes, echo=FALSE}
DiagrammeR("
graph TB
 A[Wendy]-- send proposal -->B[Vanessa HAT]
 A[Wendy]-- send proposal -->F[Nancy RNS]
 B-- decision needed -->C(Decide if I can start ER390 Fall 2025)
 F-- decision needed -->C(Decide if I can start ER390 Fall 2025)
 A-- analyzes & cleans -->B1(Data)
 B1-- results in -->G(Filtered Data)
 D-.->|if Yes ask for Data|B
 B-.->|send HAT data|A
 C-- if -->D((YES))
 C-- if -->E((NO))
 H[Variable Names]-- in -->G
 E-->I[Reconsider please?]
 I-- ask -->F
 A-- codes in -->K(RMarkdown)
 K-- to create -->J(DataVisualizations)
 J-- using -->H
 D-- begin -->L((Start Project))
 J-- used in -->M{Shiny}
 M-- reactively -->G
 L-- using -->K
 M-- produces user-chosen -->J
 
 
 style A fill:#E5E25F, stroke:#333, stroke-width:1px  
 style B fill:#87AB51, stroke:#333, stroke-width:1px  
 style B1 fill:#9AA
 style C fill:#E5E25F, stroke:#333, stroke-width:2px  
 style D fill:#87AB51
 style E fill:#cf1d2f
 style F fill:#87AB51, stroke:#333, stroke-width:1px  
 style G fill:#9AA
 style H fill:
 style I fill:
 style J fill:
 style K fill:#E5E25F, stroke:#333, stroke-width:2px  
 style L fill:#87AB51, stroke:#333, stroke-width:3px  
")
# #3C8937 Forest Green

# A Wendy
# B Vanessa
# B1 Data
# C Decide if I can start ER390 Fall 2025
# D Yes
# E No
# F Nancy
# G Filtered Data
# H Variable Names
# I Reconsider please?
# J DataVisualizations
# K RMarkdown
# L Start ER390 HAT Project
# M Shiny
```
## Examples

### Example graph
```{r mermaid-methods-flowchart-example}
DiagrammeR("
graph TB
 A-->B
 A-->C
 C-->E
 B-->D
 C-->D
 D-->F
 E-->F
")

```
### example Diagrammer shapes
```{r diagrammer-graph-shapes, echo=FALSE}
DiagrammeR("
graph LR
 A(Rounded)-->B[Squared]
 B-->C{A Decision}
 C-->D[Square One]
 C-->E[Square Two]
 E-->F((Circle))
 D-->F
 style A fill:#E5E25F, stroke:#333, stroke-width:4px  
 style B fill:#87AB51, stroke:#9AA, stroke-width:2px
 style C fill:#3C8937, stroke:#333, stroke-width:1px
 style D fill:#23772C, stroke:#333, stroke-width:2px
 style E fill:#B6E6E6, stroke:#9C2, stroke-width:2px
")
# Note: using ; semi-colons includes code at top of graph, and style doesn't work
# graph LR;A(Rounded)-->B[Squared];B-->C{A Decision};
#  C-->D[Square One];C-->E[Square Two];
#  style A fill:#E5E25F;  style B fill:#87AB51; style C fill:#3C8937;
#  style D fill:#23772C;  style E fill:#B6E6E6;
```

### example Mermaid shapes
```{r mermaid-shapes}
mermaid("
        graph BT
        A((Salinity))
        A-->B(Barnacles)
        B-.->|-0.10|B1{Mussels}
        A-- 0.30 -->B1
 
        C[Air Temp]
        C-->B
        C-.->E(Macroalgae)
        E-->B1
        C== 0.89 ==>B1
 
        style A fill:#FFF, stroke:#333, stroke-width:4px
        style B fill:#9AA, stroke:#9AA, stroke-width:2px
        style B1 fill:#879, stroke:#333, stroke-width:1px
        style C fill:#ADF, stroke:#333, stroke-width:2px
        style E fill:#9C2, stroke:#9C2, stroke-width:2px
 
        ")

```


### Example sequenceDiagram
```{r example-sequenceDiagram}
  DiagrammeR("
sequenceDiagram;
   customer->>ticket seller: ask for a ticket;
   ticket seller->>database: seats;
   alt tickets available
     database->>ticket seller: ok;
     ticket seller->>customer: confirm;
     customer->>ticket seller: ok;
     ticket seller->>database: book a seat;
     ticket seller->>printer: print a ticket;
   else sold out
     database->>ticket seller: none left;
     ticket seller->>customer: sorry;
   end
")
```


## Gantt Charts for Timelines
### Style Gantt code chunk
- supposed to widen Gantt chart, but doesn't
```{css, echo = FALSE}
# https://github.com/laurent22/joplin/issues/6711
# https://bookdown.org/yihui/rmarkdown-cookbook/chunk-styling.html
  .wider-gantt {
	width:100%;
  font-size:14;
  }
```
### Gantt Chart ER390
```{r class.source="wider-gantt",  gantt}
mermaid("
gantt
dateFormat  YYYY-MM-DD
title ER390 HAT Data Viz Project Timeline

section ER390 Project
  Nancy suggested Topic          :crit, done, first_7, 2025-07-22, 2025-07-23
  Talked to Vanessa at HAT       :crit, done, first_8, 2025-08-27,  2025-08-28
  Writing Proposal               :crit, active, first_9, 2025-08-27, 5d
  Start Project  			           :active, first_10, 2025-09-03, 356d

section Important Things
  Applied For RNS Program         :crit, done, 2025-08-21, 24h
  Created Gantt Chart             :active, 2025-08-31, 24h

section Basic Tasks
  Creating RMarkdown code    :done, a1, 2025-08-04, 2025-08-31
  Writing Proposal            :active, after a1, 2025-08-31, 3d
  Email Nancy-RNS & Vanessa-HAT :active, 2025-09-02

section Shiny App
  Created Shiny App             :done, first_1, 2025-08-18, 2025-08-28
  Refining Shiny App            :active, first_5, 2025-08-18, 130d
  Interactive Data Table        :done, 2025-08-18, 2025-08-19

section RMarkdown
  Created Test Document         :done, first_6, 2025-08-04, 2025-08-05

section Shiny Clone
  Create Shiny Clone            :active, first_11, 2025-09-30, 150d

section Data Collection
  Collecting Example Data       :done, first_2, 2025-08-04, 10d
  Finish Collecting Data        : first_3, after first_2, 5d
  Do this after that            : first_4, after first_3, 5d

section Critical Tasks
  Completed, critical task      :done, done, import_1, 2025-08-18, 24h
  Also done, also critical      :active, done, import_2, after import_1, 2d
  Doing this important task now :active, active, import_3, after import_2, 3d
  Next critical task            :active, import_4, after import_3, 5d


section Interactive Data Viz
  First extras                  : extras_1, after import_4, 3d
  Second helping                : extras_2, after extras_1, 20h
  More of the extras            : extras_3, after extras_1, 48h
  
section The Extras
  Customize colours for HAT     :  2025-10-01, 2025-12-15
  Create R Package for HAT      :  2026-01-31, 2026-04-30


")

```

### Gantt ER390 dataframe
```{r gantt-df}
ER390_gantt <- read.csv("ER390-Gantt-Tasks.csv", header = TRUE, sep = ",")

library(tidyr)
library(dplyr)
library(DiagrammeR)

mermaid(
  paste0(
    # mermaid "header", each component separated with "\n" (line break)
    "gantt", "\n",
    "dateFormat  YYYY-MM-DD", "\n",
    "title ER390 HAT Data Viz Project Timeline", "\n",
    # unite the first two columns (task & status) and separate them with ":"
    # then, unite the other columns and separate them with ","
    # this will create the required mermaid "body"
    paste(ER390_gantt %>%
            unite(i, task, status, sep = ":") %>%
            unite(j, i, pos, start, end, sep = ",") %>%
            .$j,
          collapse = "\n"
    ), "\n"
  )
)

```



### Gantt ggplot 1
```{r}
library(reshape2)
library(ggplot2)

tasks <- c("Review literature", "Mung data", "Stats analysis", "Write Report")
dfr <- data.frame(
  name        = factor(tasks, levels = tasks),
  start.date  = as.Date(c("2010-08-24", "2010-10-01", "2010-11-01", "2011-02-14")),
  end.date    = as.Date(c("2010-10-31", "2010-12-14", "2011-02-28", "2011-04-30")),
  is.critical = c(TRUE, FALSE, FALSE, TRUE)
)
mdfr <- melt(dfr, measure.vars = c("start.date", "end.date"))

gantt_ggplot <- ggplot(mdfr, aes(value, name, colour = is.critical)) + 
  geom_line(size = 6) +
  xlab(NULL) + 
  ylab(NULL)
gantt_ggplot

```

```{r}
# https://stackoverflow.com/questions/3550341/gantt-charts-with-r

tasks <- c("Review literature", "Mung data", "Stats analysis", "Write Report")
dfr <- data.frame(
  name        = factor(tasks, levels = tasks),
  start.date  = as.Date(c("2010-08-24", "2010-10-01", "2010-11-01", "2011-02-14")),
  end.date    = as.Date(c("2010-10-31", "2010-12-14", "2011-02-28", "2011-04-30")),
  is.critical = c(TRUE, FALSE, FALSE, TRUE)
)

ggplot(dfr, aes(x =start.date, xend= end.date, y=name, yend = name, color=is.critical)) +
  geom_segment(size = 6) +
  xlab(NULL) + ylab(NULL)
```

### Gantt ggplot 2
```{r}
library(reshape2)
tasks <- c("Review literature", "Mung data", "Stats analysis", "Write Report")
dfrP <- data.frame(
  name        = factor(tasks, levels = tasks),
  start.date  = as.Date(c("2010-08-24", "2010-10-01", "2010-11-01", "2011-02-14")),
  end.date    = as.Date(c("2010-10-31", "2010-12-14", "2011-02-28", "2011-04-30")),
  is.critical = c(TRUE, FALSE, FALSE, TRUE)
)
dfrR <- data.frame(
  name        = factor(tasks, levels = tasks),
  start.date  = as.Date(c("2010-08-22", "2010-10-10", "2010-11-01", NA)),
  end.date    = as.Date(c("2010-11-03", "2010-12-22", "2011-02-24", NA)),
  is.critical = c(TRUE, FALSE, FALSE,TRUE)
)
mdfr <- merge(data.frame(type="Plan", melt(dfrP, measure.vars = c("start.date", "end.date"))),
  data.frame(type="Real", melt(dfrR, measure.vars = c("start.date", "end.date"))), all=T)

library(ggplot2)
ggplot(mdfr, aes(x=value, y=type, color=is.critical))+
  geom_line(size=6)+
  facet_grid(name ~ .) +
  scale_y_discrete(limits=c("Real", "Plan")) +
  xlab(NULL) + ylab(NULL)

```

### Gantt timevis interactive
```{r}
# https://stackoverflow.com/questions/3550341/gantt-charts-with-r
library(timevis)

data <- data.frame(
  id      = 1:4,
  content = c("Item one"  , "Item two"  ,"Ranged item", "Item four"),
  start   = c("2016-01-10", "2016-01-11", "2016-01-20", "2016-02-14 15:00:00"),
  end     = c(NA          ,           NA, "2016-02-04", NA)
)

timevis(data)

```


---

# TO DO
- leaflet map jumps when clicking popup (in RStudio, not in html file)

## DONE
### to combine dataframes csv files to include site info
1. make sure they each have same length number of unique rows
2. arrange alphabetic order
3. cbind
4. remove duplicate columns

# Session info
```{r session-info}
# to document specific packages used to run script
sessionInfo()
```








