---
title: "Warming Stripes"
author: "Wendy Anthony"
date: "2021/09/05 - 2022/03/13"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Install Packages | Load Libraries

```{r install_packages, include=FALSE, echo=FALSE}
if(!require("lubridate")) install.packages("lubridate")
if(!require("tidyverse")) install.packages("tidyverse")
if(!require("RColorBrewer")) install.packages("RColorBrewer")
```

## Load Libraries

```{r load_libraries, echo=TRUE, include=TRUE}
library("tidyverse")       # for dates ymd( )  
library("lubridate")       # for ggplot2; stringr str_c( )  
library("RColorBrewer")    # for colour scheme
```

## Working Directory 
is automatically set within project, so no need to reset

```{r check_working_directory}
getwd()
```

# DATA
## Import .csv file of monthly time-series data 

Historical Data: [Search for monthly Environment Canada Station Data](https://climate.weather.gc.ca/historical_data/search_historic_data_stations_e.html?searchType=stnName&timeframe=1&txtStationName=victoria+Int%27l&searchMethod=contains&optLimit=yearRange&StartYear=1840&EndYear=2021&Year=2021&Month=5&Day=9&selRowPerPage=25)  
  
* .csv file will need some data cleaning / manipulation before use  
  
* columns have monthly and seasonal values, and annual temperature value

## Load Data {.smaller} 

```{r load_data}
climate_victoria <- read_csv("VictoriaINTL-INT'L-climate-daily-1940-2021.csv")
```

## get data info {.smaller}

```{r data_info}
class(climate_victoria)
head(climate_victoria)
```

## more data info {.smaller} 
<details><summary><b><i>Click to see results of `str(climate_victoria)`</i></b></summary><p>
```{r str}
str(climate_victoria)
```
</p></details>

## Select Columns | Year and Year Average temperature {.smaller}  

```{r select_columns_temp_year}
temp_victoria_yr <- climate_victoria %>% select(LOCAL_YEAR, LOCAL_MONTH, 
                                                LOCAL_DAY, MEAN_TEMPERATURE, 
                                                MIN_TEMPERATURE, MAX_TEMPERATURE)
temp_victoria_yr
```

## rename the columns {.smaller}
format: newname = oldname
```{r rename_column}
temp_victoria_yr <- temp_victoria_yr %>% rename(Year = LOCAL_YEAR, Month = LOCAL_MONTH, 
                                                Day = LOCAL_DAY, TempMean = MEAN_TEMPERATURE, 
                                                TempMin = MIN_TEMPERATURE, TempMax = MAX_TEMPERATURE)
temp_victoria_yr
```

## Check summary stats {.smaller} 
to see if data contains any missing values  
i.e. 999.9 (this would show as the max value)  

```{r summary_stats}
summary(temp_victoria_yr)
```

## Use the ifelse( ) function to replace missing values 999.9 with NA   {.smaller}

```{r missing_values}
temp_victoria_yr <- mutate(temp_victoria_yr, 
                           TempMean = ifelse(TempMean == 999.9, NA, TempMean))
temp_victoria_yr
```

## Create Date Column {.smaller} 
* lubridate::ymd() function converts date character to Date object  
```{r create_date_column}
temp_victoria_yr$Date <- paste(temp_victoria_yr$Year, temp_victoria_yr$Month, 
                               temp_victoria_yr$Day, sep="-") %>% ymd() %>% as.Date()
```

## See Data details for date {.smaller} 
<details><summary><b><i>Click to see results of `str(temp_victoria_yr$Date)`</i></b></summary><p>
```{r explore_date_column}
str(temp_victoria_yr$Date)
temp_victoria_yr$Date
```
</p></details>

## Filter for one year {.smaller} 
```{r filter_one_year}
temp_victoria_2021 <- temp_victoria_yr[temp_victoria_yr$Date >= "2021-01-01" 
                                       & temp_victoria_yr$Date <= "2021-12-31", ]
temp_victoria_2021
```

## Mean for one year {.smaller} 
* some years have NA for the mean: 1940, 1941, 1948, 1996, 1997, 1998, 2004, 2014, 2016, 2017, 2018, 2019, 2020, 2021  
* need to add na.rm = TRUE to take mean of only cells with a value i.e. not NA
```{r year_mean}
groupby_temp_victoria <- temp_victoria_yr %>% 
  group_by(Year)  %>% 
  summarize(TempMean = mean(TempMean, na.rm = TRUE))
str(temp_victoria_2021)
```

## Convert year variable to a date object {.smaller} 
* for ease of use with ```Lubridate``` and ```ggplot2``` packages  
* tidyverse::str_c() function enables character combinations by specifiying a separator sep="-"  
* lubridate::ymd() function converts date character to Date object

```{r mutate_date}
groupby_temp_victoria <- mutate(groupby_temp_victoria, 
                           date = str_c(Year, "01-01", sep = "-") %>%
                           ymd())
groupby_temp_victoria
```

# Create the Stripes
## Create Theme default theme_minimal() {.smaller} 

```{r theme_minimal}
theme_strip <- theme_minimal()+
                 theme(axis.text.y = element_blank(),
                       axis.line.y = element_blank(),
                       axis.title = element_blank(),
                       panel.grid.major = element_blank(),
                       legend.title = element_blank(),
                       axis.text.x = element_text(vjust=3, size = 08),
                       panel.grid.minor = element_blank(),
                       plot.title=element_text(size = 14, face = "bold", hjust = 0.5),
                       plot.subtitle = element_text(face = "italic", hjust = 0.5)
                       )
```

## Assign colours using RColorBrewer  
[ColorBrewer](https://colorbrewer2.org/)  

```{r color_assignment}
# get names of colours
brewer.pal.info

## assign the colors from RColorBrewer to object col_srip.
col_strip <- brewer.pal(11,"RdBu")
```

## Create graphic with color-bar legend using ggplot2
* data doesn't have a value for Y axis, so dummy value of 1 is used  
* geometry used geom_tile()  
* guide_colorbar(barwidth = 1) controls width of legend color bar  

```{r}
str(groupby_temp_victoria)
```

## remove rows for years of incomplete data {.smaller} 

```{r remove_rows}
groupby_temp_victoria <- groupby_temp_victoria[groupby_temp_victoria$Year != 1940, ]
groupby_temp_victoria <- groupby_temp_victoria[groupby_temp_victoria$Year != 2022, ]
```

## Create Mean Temperature Plot {.smaller} 

```{r ggplot_graphic_legend_4}
## stripes plot with the legend

# Define Start and end times for the subset as R objects that are the time class
startTime <- as.Date("1941-01-01")
endTime <- as.Date("2021-01-01")

# create a start and end time R object >>> scale_x_date(limits=start.end,
start.end <- c(startTime,endTime)
start.end

stplt_lg <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = TempMean)) +
        geom_tile() +
           scale_x_date(limits=start.end,
                        date_breaks = "5 years",
                        date_labels = "%Y",
                        expand = c(0, 0)) +
           scale_y_continuous(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip)) +
             guides(fill = guide_colorbar(barwidth = 1)) +
            labs(title = "Victoria BC Intl. Airport 
                 \nAverage Yearly Mean °C Temperature 1941-2021",
                caption = "Using historical climate data from Environment Canada
                \nhttps://climate.weather.gc.ca/historical_data/search_historic_data_e.html
                \n chart by Wendy Anthony") +
          theme_strip +
          theme(plot.title=element_text(size = 12)) # smaller text size, no line break
```

## Display Climate Stripes

```{r stplt_lg}
stplt_lg
```


## Create image files with legend

```{r create_image_files_legend}
# png files have very poor resolution >>> add res = 300

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-lg.pdf")
stplt_lg
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-lg.tiff", units="in", width=5, height=5, res=300)
stplt_lg
dev.off()
```

## Create graphic stripes only, no legend
* geom_tile(show.legend = FALSE)  
* use theme_void() to remove all theme styling  
* NA values can have a different color by adding na.value = "gray70" to scale_fill_gradientn()  

```{r ggplot_graphic_no_legend_1}
stplt <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = TempMean)) +
        geom_tile(show.legend = FALSE) +
           scale_x_date(date_breaks = "6 years",
                     date_labels = "%Y",
                     expand = c(0, 0)) +
           scale_y_discrete(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip), na.value = "gray70") +
             theme_void()
stplt
```

## Create image files with no legend

```{r create_image_files_no_legend}
# png files have very poor resolution

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-nolg.pdf")
stplt
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-nolg.tiff", units="in", width=5, height=5, res=300)
stplt
dev.off()
```

## Create Temperature Anomaly chart
* For each country-level #ShowYourStripes graphic (Hawkins, June 2019), the average temperature in the 1971-2000 reference period is set (https://en.wikipedia.org/wiki/Warming_stripes)  
* [Victoria INT'L Airport Climate Normal Data 1971-2000](https://climate.weather.gc.ca/climate_normals/results_e.html?searchType=stnName&txtStationName=Victoria+Int&searchMethod=contains&txtCentralLatMin=0&txtCentralLatSec=0&txtCentralLongMin=0&txtCentralLongSec=0&stnID=118&dispBack=1)  
* Yearly Daily Average Temperature 1971-2000 was 9.7ºC  

## add new columns for anomalies {.smaller} 
* to groupby_temp_victoria for climate norm, then another for anomaly

```{r create new column for climate norm}
groupby_temp_victoria$Norm <- "9.7"
str(groupby_temp_victoria) #chr
# change chr >> num
groupby_temp_victoria$Norm <- as.numeric(groupby_temp_victoria$Norm)

groupby_temp_victoria$Anomaly <- (groupby_temp_victoria$TempMean - groupby_temp_victoria$Norm)
groupby_temp_victoria
```

## create anomaly plot
```{r ggplot_graphic_legend_anomaly}
## stripes plot with the legend

# Define Start and end times for the subset as R objects that are the time class
startTime <- as.Date("1941-01-01")
endTime <- as.Date("2021-01-01")

# create a start and end time R object >>> scale_x_date(limits=start.end,
start.end <- c(startTime,endTime)
start.end

stplt_lg_anom <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = Anomaly)) +
        geom_tile() +
           scale_x_date(limits=start.end,
                        date_breaks = "5 years",
                        date_labels = "%Y",
                        expand = c(0, 0)) +
           scale_y_continuous(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip)) +
             guides(fill = guide_colorbar(barwidth = 1)) +
            labs(title = "Victoria BC Intl. Airport
                 \nAnnual °C Temperature Anomaly 1941-2021",
                 subtitle = "(Based on Victoria INT'L Airport Climate Normals 1971-2000)",
                caption = "Using historical climate data from Environment Canada
                \nhttps://climate.weather.gc.ca/historical_data/search_historic_data_e.html 
                \n chart by Wendy Anthony") +
          theme_strip
```

## Anomaly Chart

```{r stplt_lg_anom}
stplt_lg_anom
```

## create plot files of anomaly with legend
```{r create_image_files_legend_anomaly}
# png files have very poor resolution >>> add res = 300

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-lg-anom.pdf")
stplt_lg_anom
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-lg-anom.tiff", units="in", width=5, height=5, res=300)
stplt_lg_anom
dev.off()
```

## create anomaly plot with no legend {.smaller} 

```{r ggplot_graphic_no_legend_anomaly}
# Define Start and end times for the subset as R objects that are the time class
startTime <- as.Date("1941-01-01")
endTime <- as.Date("2021-01-01")
# create a start and end time R object >>> scale_x_date(limits=start.end,
start.end <- c(startTime,endTime)
start.end

stplt_nolg_anom <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = Anomaly)) +
        geom_tile() +
           scale_x_date(limits=start.end,
                        date_breaks = "5 years",
                        date_labels = "%Y",
                        expand = c(0, 0)) +
           scale_y_continuous(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip)) +
           guides(fill = guide_colorbar(barwidth = 1)) +
           labs(title = "Victoria BC Intl. Airport Mean Temperature°C Anomaly 1941-2021",
                subtitle = "(Based on Env Canada Victoria INT'L Airport Climate Normals 1971-2000)") +
          theme_strip +
          theme(   # modify theme_strip
            legend.position = "none", # no legend
            plot.title=element_text(size = 8), # smaller text size, no line break
            plot.subtitle=element_text(size = 7), # smaller text size
            axis.text.x = element_blank()) # no x-axis text
```

## Display Climate Stripes no legend

```{r stplt_nolg_anom}
stplt_nolg_anom
```


## create plot files of anomaly without legend {.smaller} 

```{r create_image_files_nolegend_anomaly}
# png files have very poor resolution >>> add res = 300

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-nolg-anom.pdf")
stplt_nolg_anom
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-nolg-anom.tiff", units="in", width=5, height=5, res=300)
stplt_nolg_anom
dev.off()
```

## Add text to plot ????????? {.smaller} 
* y axis has no value (except 1), so difficult to place; vjust="top" doesn't work ???

```{r ggplot_graphic_no_legend_2}
stplt_txt <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = TempMean)) +
        geom_tile(show.legend = FALSE) +
           scale_x_date(date_breaks = "6 years",
                     date_labels = "%Y",
                     expand = c(0, 0)) +
           scale_y_discrete(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip), na.value = "gray70") +
             theme_void() +
  geom_text(x = 1941, y = 1, aes(label = "Victoria INT'L \nMean Temp 
                                 \n1941-2021"), vjust = "top", hjust = "center")
#   geom_text(x = 1941, label = "Victoria INT'L Mean Temp 1941-2021") # WORKS
#  annotate(geom = "text", label = "Victoria INT'L Mean Temp 1941-2021", color = "black")
```

## Display add text to plot

```{r stplt_txt}
stplt_txt
```

## create plot files of anomaly without legend

```{r create_image_files_splittitle_plot}
# png files have very poor resolution >>> add res = 300

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-textplot.pdf")
stplt_txt
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-textplot.tiff", units="in", width=5, height=5, res=300)
stplt_txt
dev.off()
```

## Add title to plot 

```{r ggplot_graphic_title_text_on_plot}
stplt_title <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = TempMean)) +
        geom_tile(show.legend = FALSE) +
           scale_x_date(date_breaks = "6 years",
                     date_labels = "%Y",
                     expand = c(0, 0)) +
           scale_y_discrete(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip), na.value = "gray70") +
             theme_void() +
  ggtitle("Victoria INT'L Mean Temp 1941-2021") +
theme(plot.title=element_text(hjust=0.37, vjust=0.5, margin=margin(t=60,b=-30)))
```

## Plot with title

```{r stplt_title}
stplt_title
```

## create plot files of anomaly without legend

```{r create_image_files_title_plot}
# png files have very poor resolution >>> add res = 300

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-titleplot.pdf")
stplt_title
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-titleplot.tiff", units="in", width=5, height=5, res=300)
stplt_title
dev.off()
```

## Create Mean Temperature Plot >>> convert verticle bar to round? {.smaller} 

```{r ggplot_graphic_legend_3}
## stripes plot with the legend
stplt_lg_rnd <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = TempMean)) +
        geom_tile() +
           scale_x_date(limits=start.end,
                        date_breaks = "5 years",
                        date_labels = "%Y",
                        expand = c(0, 0)) +
           scale_y_continuous(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip)) +
             guides(fill = guide_colorbar(barwidth = 1)) +
            labs(title = "Victoria BC Intl. Airport \nAverage Yearly Mean °C Temperature 1941-2021",
                caption = "Using historical climate data from Environment Canada\nhttps://climate.weather.gc.ca/historical_data/search_historic_data_e.html\n chart by Wendy Anthony") +
          theme_strip +
          theme(plot.title=element_text(size = 12)) + # smaller text size, no line break
coord_polar()
```

## Chart with polar coord

```{r stplt_lg_rnd}
stplt_lg_rnd
```


## create plot files trying for round - coord_polar()

```{r create_image_files_legend_round}
# png files have very poor resolution >>> add res = 300

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-coordpolar.pdf")
stplt_lg_rnd
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-coordpolar.tiff", units="in", width=5, height=5, res=300)
stplt_lg_rnd
dev.off()
```

## Create Mean Temperature Plot >>> convert verticle bar to round?  ???????

```{r ggplot_graphic_legend_barround}
## stripes plot with the legend

stplt_lg_barrnd <- ggplot(groupby_temp_victoria,
             aes(x = date, fill = TempMean)) +
             #scale_y_continuous(expand = c(0, 0)) +
           #scale_fill_gradientn(colors = rev(col_strip)) +
             #guides(fill = guide_colorbar(barwidth = 1)) +
   #theme_strip +
  geom_bar() +
coord_polar(theta = "y")
```

## PLot in round ?

```{r stplt_lg_barrnd}
stplt_lg_barrnd
```

## Thanx to: 
* Based on 2018 code by Dominic Royé  
[How to Create Warming Stripes in R](https://www.r-bloggers.com/how-to-create-warming-stripes-in-r/)  
* Github for hosting this presentation  
* R Markdown ioslides_presentation
