---
title: "Warming Stripes"
author: "Wendy Anthony"
date: "2021/09/05 - 2022/01/09"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Based on 2018 code by Dominic Royé for [How to Create Warming Stripes in R](https://www.r-bloggers.com/how-to-create-warming-stripes-in-r/)

# Install Packages
```lubridate```    for dates ymd( )  
```tidyverse```    for ggplot2; stringr str_c( )  
```RColorBrewer``` for colour scheme  

```{r install_packages, include=FALSE, echo=FALSE}
if(!require("lubridate")) install.packages("lubridate")
if(!require("tidyverse")) install.packages("tidyverse")
if(!require("RColorBrewer")) install.packages("RColorBrewer")
```

## Load Libraries

```{r load_libraries, echo=TRUE, include=TRUE}
library("tidyverse")
library("lubridate")
library("RColorBrewer")
```

## Working Directory 
is automatically set within project, so no need to reset

```{r check_working_directory}
#dir <- "/Users/wanthony/Documents/R/Climate-Weather"
#setwd(dir)
getwd()
```

# DATA
## import .csv file of monthly time-series data 

### Historical Data: [Search for monthly Environment Canada Station Data](https://climate.weather.gc.ca/historical_data/search_historic_data_stations_e.html?searchType=stnName&timeframe=1&txtStationName=victoria+Int%27l&searchMethod=contains&optLimit=yearRange&StartYear=1840&EndYear=2021&Year=2021&Month=5&Day=9&selRowPerPage=25)  
* .csv file will need some data cleaning / manipulation before use
* columns have monthly and seasonal values, and  annual temperature value - only for 1940-2012

### Historical Data from Climate Data  
[ClimateData.ca](https://climatedata.ca/download/#station-download)  
Dowload data for both VICTORIA INTL A and VICTORIA INT'L A

```{r load_data}
climate_victoria <- read_csv("VictoriaINTL-INT'L-climate-daily-1940-2021.csv")
```

## get data info

```{r data_info}
class(climate_victoria)
head(climate_victoria)
```

<details><summary>Click here
```{r}
str(climate_victoria)
```
</summary></details>

# Select Columns: Year and Year Average temperature  

```{r select_columns_temp_year}
temp_victoria_yr <- climate_victoria %>% select(LOCAL_YEAR, LOCAL_MONTH, LOCAL_DAY, MEAN_TEMPERATURE, MIN_TEMPERATURE, MAX_TEMPERATURE)
temp_victoria_yr
```

## rename the columns
format: newname = oldname
```{r rename_column}
temp_victoria_yr <- temp_victoria_yr %>% rename(Year = LOCAL_YEAR, Month = LOCAL_MONTH, Day = LOCAL_DAY, TempMean = MEAN_TEMPERATURE, TempMin = MIN_TEMPERATURE, TempMax = MAX_TEMPERATURE)
temp_victoria_yr
```

### Check summary stats to see if data contains any missing values i.e. 999.9 (this would show as the max value)  

```{r summary_stats}
summary(temp_victoria_yr)
```

### Use the ifelse( ) function to replace missing values 999.9 with NA  

```{r missing_values}
temp_victoria_yr <- mutate(temp_victoria_yr, 
                           TempMean = ifelse(TempMean == 999.9, NA, TempMean))
temp_victoria_yr
```

## Create Date Column
* lubridate::ymd() function converts date character to Date object

```{r create_date_column}

temp_victoria_yr$Date <- paste(temp_victoria_yr$Year, temp_victoria_yr$Month, temp_victoria_yr$Day, sep="-") %>% ymd() %>% as.Date()

str(temp_victoria_yr$Date)
temp_victoria_yr$Date
```


## Filter for one year
```{r filter_one_year}
temp_victoria_2021 <- temp_victoria_yr[temp_victoria_yr$Date >= "2021-01-01" & temp_victoria_yr$Date <= "2021-12-31", ]
temp_victoria_2021
```

### Mean for one year
* ???? some years have NA for the mean: 1940, 1941, 1948, 1996, 1997, 1998, 2004, 2014, 2016, 2017, 2018, 2019, 2020, 2021 ?????     
* need to add na.rm = TRUE to take mean of only cells with a value i.e. not NA
```{r year_mean}
groupby_temp_victoria <- temp_victoria_yr %>% 
  group_by(Year)  %>% 
  summarize(TempMean = mean(TempMean, na.rm = TRUE))
```


## Convert year variable to a date object for ease of use with ```Lubridate``` and ```ggplot2``` packages  
* tidyverse::str_c() function enables character combinations by specifiying a separator sep="-"  
* lubridate::ymd() function converts date character to Date object

```{r mutate_date}
groupby_temp_victoria <- mutate(groupby_temp_victoria, 
                           date = str_c(Year, "01-01", sep = "-") %>%
                           ymd())
groupby_temp_victoria
```

# Create the Stripes
## Create default theme_minimal() style 

```{r theme_minimal}
theme_strip <- theme_minimal()+
                 theme(axis.text.y = element_blank(),
                       axis.line.y = element_blank(),
                       axis.title = element_blank(),
                       panel.grid.major = element_blank(),
                       legend.title = element_blank(),
                       axis.text.x = element_text(vjust=3, size = 08),
                       panel.grid.minor = element_blank(),
                       plot.title=element_text(size = 14, face = "bold", hjust = 0.5),
                       plot.subtitle = element_text(face = "italic", hjust = 0.5)
                       )
```

### Assign colours using RColorBrewer  
[ColorBrewer](https://colorbrewer2.org/)  

```{r color_assignment}
# get names of colours
brewer.pal.info

## assign the colors from RColorBrewer to object col_srip.
col_strip <- brewer.pal(11,"RdBu")
```

## Create graphic with color-bar legend using ggplot2
* data doesn't have a value for Y axis, so dummy value of 1 is used  
* geometry used geom_tile()  
* guide_colorbar(barwidth = 1) controls width of legend color bar  

```{r}
str(groupby_temp_victoria)
```

## remove rows for years of incomplete data
```{r remove_rows}
groupby_temp_victoria <- groupby_temp_victoria[groupby_temp_victoria$Year != 1940, ]
groupby_temp_victoria <- groupby_temp_victoria[groupby_temp_victoria$Year != 2022, ]
```


# Create Mean Temperature Plot
```{r ggplot_graphic_legend}
## stripes plot with the legend

# Define Start and end times for the subset as R objects that are the time class
startTime <- as.Date("1941-01-01")
endTime <- as.Date("2021-01-01")

# create a start and end time R object >>> scale_x_date(limits=start.end,
start.end <- c(startTime,endTime)
start.end

stplt_lg <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = TempMean)) +
        geom_tile() +
           scale_x_date(limits=start.end,
                        date_breaks = "5 years",
                        date_labels = "%Y",
                        expand = c(0, 0)) +
           scale_y_continuous(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip)) +
             guides(fill = guide_colorbar(barwidth = 1)) +
            labs(title = "Victoria BC Intl. Airport \nAverage °C Temperature 1941-2021",
                caption = "Annual Average Temperature Analysis (°Celsius)\nUsing historical climate data from Environment Canada\nhttps://climate.weather.gc.ca/historical_data/search_historic_data_e.html\n\n by Wendy Anthony") +
          theme_strip
stplt_lg
```


### Create image files with legend

```{r create_image_files_legend}
# png files have very poor resolution >>> add res = 300
png("VictoriaClimateStripes-1941-2021-lg.png", units="in", width=6, height=5, res = 300)
stplt_lg
dev.off()

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-lg.pdf")
stplt_lg
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-lg.tiff", units="in", width=5, height=5, res=300)
stplt_lg
dev.off()
```

## Create graphic stripes only, without a color-bar legend
* geom_tile(show.legend = FALSE)  
* use theme_void() to remove all theme styling  
* NA values can have a different color by adding na.value = "gray70" to scale_fill_gradientn()  

```{r ggplot_graphic_no_legend}
stplt <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = TempMean)) +
        geom_tile(show.legend = FALSE) +
           scale_x_date(date_breaks = "6 years",
                     date_labels = "%Y",
                     expand = c(0, 0)) +
           scale_y_discrete(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip), na.value = "gray70") +
             theme_void()
stplt
```

### Create image files with no legend

```{r create_image_files_no_legend}
# png files have very poor resolution
png("VictoriaClimateStripes-1941-2021-nolg.png")
stplt
dev.off()

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-nolg.pdf")
stplt
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-nolg.tiff", units="in", width=5, height=5, res=300)
stplt
dev.off()
```

# Create Temperature Anomaly chart
* For each country-level #ShowYourStripes graphic (Hawkins, June 2019), the average temperature in the 1971-2000 reference period is set (https://en.wikipedia.org/wiki/Warming_stripes)  
* [Victoria INT'L Airport Climate Normal Data 1971-2000](https://climate.weather.gc.ca/climate_normals/results_e.html?searchType=stnName&txtStationName=Victoria+Int&searchMethod=contains&txtCentralLatMin=0&txtCentralLatSec=0&txtCentralLongMin=0&txtCentralLongSec=0&stnID=118&dispBack=1)  
* Yearly Daily Average Temperature 1971-2000 was 9.7ºC  

## add new columns for anomalies
* to groupby_temp_victoria for climate norm, then another for anomaly
```{r create new column for climate norm}
groupby_temp_victoria$Norm <- "9.7"
str(groupby_temp_victoria) #chr
# change chr >> num
groupby_temp_victoria$Norm <- as.numeric(groupby_temp_victoria$Norm)

groupby_temp_victoria$Anomaly <- (groupby_temp_victoria$TempMean - groupby_temp_victoria$Norm)
groupby_temp_victoria
```

## create anomaly plot
```{r ggplot_graphic_legend_anomaly}
## stripes plot with the legend

# Define Start and end times for the subset as R objects that are the time class
startTime <- as.Date("1941-01-01")
endTime <- as.Date("2021-01-01")

# create a start and end time R object >>> scale_x_date(limits=start.end,
start.end <- c(startTime,endTime)
start.end

stplt_lg_anom <- ggplot(groupby_temp_victoria,
             aes(x = date, y = 1, fill = Anomaly)) +
        geom_tile() +
           scale_x_date(limits=start.end,
                        date_breaks = "5 years",
                        date_labels = "%Y",
                        expand = c(0, 0)) +
           scale_y_continuous(expand = c(0, 0)) +
           scale_fill_gradientn(colors = rev(col_strip)) +
             guides(fill = guide_colorbar(barwidth = 1)) +
            labs(title = "Victoria BC Intl. Airport\n°C Temperature Anomaly 1941-2021",
                 subtitle = "(Based on Victoria INT'L Airport Climate Normals 1971-2000)",
                caption = "Annual Temperature Anomaly Analysis (°Celsius)\nUsing historical climate data from Environment Canada\nhttps://climate.weather.gc.ca/historical_data/search_historic_data_e.html \n\n chart by Wendy Anthony") +
          theme_strip
stplt_lg_anom
```

### create plot files
```{r create_image_files_legend_anomaly}
# png files have very poor resolution >>> add res = 300
png("VictoriaClimateStripes-1941-2021-lg-anom.png", units="in", width=6, height=5, res = 300)
stplt_lg_anom
dev.off()

# pdf files have better resolution
pdf("VictoriaClimateStripes-1941-2021-lg-anom.pdf")
stplt_lg_anom
dev.off()

# tiff files have best resolution, with a larger file-size; specify size and resolution
tiff("VictoriaClimateStripes-1941-2021-lg-anom.tiff", units="in", width=5, height=5, res=300)
stplt_lg_anom
dev.off()
```
